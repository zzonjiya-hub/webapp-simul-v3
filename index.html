<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‹¤ì‹œë®¬ë ˆì´í„° v3.1 - Google Sheets ì—°ë™</title>
    <!-- Noto Sans KR í°íŠ¸ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        :root {
            --ui-margin: 30px;
            --ui-margin-mobile: 20px;
        }
        
        @media (max-width: 768px) {
            :root {
                --ui-margin: var(--ui-margin-mobile);
            }
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            background: #000;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        #dialogue-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            z-index: 1000;
        }
        
        #dialogue-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            transition: all 0.3s ease;
            font-weight: bold;
            line-height: 1;
        }
        
        #dialogue-close-btn:hover {
            background: rgba(217, 115, 86, 0.2);
            color: #D97356;
            transform: scale(1.1);
        }
        
        #dialogue-close-btn:active {
            transform: scale(0.95);
        }
        
        #dialogue-box h3 {
            margin: 0 0 10px 0;
            color: #D97356;
        }
        
        #dialogue-content {
            margin: 10px 0;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dialogue-option {
            background: #f0f0f0;
            border: 2px solid #D97356;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dialogue-option:hover {
            background: #D97356;
            color: white;
            transform: translateX(5px);
        }
        
        #custom-question-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        #custom-question-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #D97356;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        #custom-question-submit {
            background: #D97356;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #custom-question-submit:hover {
            background: #c85a3f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        #custom-question-submit:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(217, 115, 86, 0.3);
            border-radius: 50%;
            border-top-color: #D97356;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instruction {
            opacity: 0.8;
            font-size: 14px;
            margin-top: 10px;
        }
        
        #interaction-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: none;
            font-size: 36px;
            font-weight: bold;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        #interaction-prompt:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
            border-color: rgba(255, 255, 255, 1);
        }
        
        #interaction-prompt:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        
        .floating-text {
            position: absolute;
            color: #ff0;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }
        
        /* ìƒ‰ì¢…ì´ ì• ë‹ˆë©”ì´ì…˜ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
            z-index: 9999;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateX(720deg) rotateY(720deg) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        /* ì¶•í•˜ ë©”ì‹œì§€ */
        #celebration-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 215, 0, 0.95);
            color: #333;
            padding: 40px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            animation: celebration-appear 0.5s ease-out forwards;
        }
        
        @keyframes celebration-appear {
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ (ì™¼ìª½ ì•„ë˜) */
        #navigation-controls {
            position: fixed;
            bottom: var(--ui-margin);
            left: var(--ui-margin);
            z-index: 100;
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(2, 100px);
            gap: 12px;
            will-change: transform;
        }
        
        .nav-button {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        .nav-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* ìŠ¤í¬ë¦°ìƒ· ë²„íŠ¼ (ì™¼ìª½ ìœ„) */
        #screenshot-button {
            position: fixed;
            top: var(--ui-margin);
            left: var(--ui-margin);
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            padding: 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }
        
        #screenshot-button svg {
            width: 50px;
            height: 50px;
            fill: none;
            stroke: white;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        #screenshot-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        #screenshot-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* ì „ì²´í™”ë©´ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ìœ„) */
        #fullscreen-button {
            position: fixed;
            top: var(--ui-margin);
            right: var(--ui-margin);
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            will-change: transform;
        }
        
        #fullscreen-button svg {
            width: 45px;
            height: 45px;
            fill: none;
            stroke: white;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        #fullscreen-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        #fullscreen-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* ì§„í–‰ ìƒíƒœë°” (ì˜¤ë¥¸ìª½ ì•„ë˜) */
        #progress-bar {
            position: fixed;
            bottom: var(--ui-margin);
            right: var(--ui-margin);
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 50px;
            font-weight: bold;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', sans-serif;
            letter-spacing: -2px;
            line-height: 1;
            padding-bottom: 3px;
            will-change: contents;
        }
        
        /* UI ìˆ¨ê¸°ê¸° í´ë˜ìŠ¤ */
        .hide-ui {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <!-- UI ì˜¤ë²„ë ˆì´ ì œê±°ë¨ -->
    
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;">
        <div style="font-size: 24px; margin-bottom: 20px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
            <div id="loading-bar" style="width: 0%; height: 100%; background: #D97356; transition: width 0.3s;"></div>
        </div>
        <div id="loading-status" style="margin-top: 10px; font-size: 14px; opacity: 0.8;">Google Sheets ì—°ê²° ì¤‘...</div>
    </div>
    
    <div id="dialogue-box">
        <button id="dialogue-close-btn">Ã—</button>
        <h3 id="dialogue-name">ì´ë¦„</h3>
        <div id="dialogue-content" style="font-size: 18px; font-weight: bold; margin-bottom: 20px;">ì§ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
        <div id="quiz-container">
            <input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 2px solid #D97356; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px;">
            <button id="submit-answer" style="width: 100%; background: #D97356; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; transition: all 0.3s;">ì •ë‹µ ì œì¶œ</button>
            <div id="feedback" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none; font-weight: bold; text-align: center;"></div>
        </div>
    </div>
    
    <div id="interaction-prompt">ëŒ€í™”í•˜ê¸°</div>
    
    <!-- ì¶•í•˜ ë©”ì‹œì§€ -->
    <div id="celebration-message">
        ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰<br>
        ëª¨ë“  ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤!
    </div>
    
    <!-- ìŠ¤í¬ë¦°ìƒ· ë²„íŠ¼ (ì™¼ìª½ ìœ„) -->
    <button id="screenshot-button" title="í™”ë©´ ìº¡ì²˜">
        <svg viewBox="0 0 24 24">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
            <circle cx="12" cy="13" r="4"></circle>
        </svg>
    </button>
    
    <!-- ì „ì²´í™”ë©´ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ìœ„) -->
    <button id="fullscreen-button" title="ì „ì²´í™”ë©´">
        <svg viewBox="0 0 24 24">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
    </button>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ (ì™¼ìª½ ì•„ë˜) -->
    <div id="navigation-controls">
        <div></div>
        <button class="nav-button" id="nav-up">â–²</button>
        <div></div>
        <button class="nav-button" id="nav-left">â—€</button>
        <button class="nav-button" id="nav-down">â–¼</button>
        <button class="nav-button" id="nav-right">â–¶</button>
    </div>
    
    <!-- ì§„í–‰ ìƒíƒœë°” (ì˜¤ë¥¸ìª½ ì•„ë˜) -->
    <div id="progress-bar">0</div>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // íš¨ê³¼ìŒ ìƒì„± í•¨ìˆ˜
        let audioContext = null;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        function playCorrectSound() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 523.25; // C5
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.5);
            
            // í™”ìŒ ì¶”ê°€
            setTimeout(() => {
                const oscillator2 = ctx.createOscillator();
                const gainNode2 = ctx.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(ctx.destination);
                
                oscillator2.frequency.value = 659.25; // E5
                oscillator2.type = 'sine';
                
                gainNode2.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                oscillator2.start(ctx.currentTime);
                oscillator2.stop(ctx.currentTime + 0.5);
            }, 100);
        }
        
        function playWrongSound() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 200; // ë‚®ì€ ìŒ
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.3);
        }
        
        function playCelebrationMusic() {
            const ctx = initAudioContext();
            const notes = [523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, 1046.50]; // C major scale
            let noteIndex = 0;
            
            const playNote = () => {
                if (noteIndex >= notes.length * 4) return; // 4ë²ˆ ë°˜ë³µ
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = notes[noteIndex % notes.length];
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.2);
                
                noteIndex++;
                setTimeout(playNote, 150);
            };
            
            playNote();
        }
        
        // Google Sheets ë°ì´í„° ì €ì¥ ë³€ìˆ˜
        let quizData = [];
        let characterQuizMap = {};
        let boardInfo = {}; // ì¹ íŒ ì •ë³´
        let characterNames = {}; // ìºë¦­í„° ì´ë¦„ ë§¤í•‘
        
        // ê¸°ë³¸ ë°ì´í„° (Google Sheets ë¡œë”© ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
        const defaultData = {
            "ì¹ íŒ 1ì¤„": "ë§ì…ˆ",
            "ì¹ íŒ 2ì¤„": "ê°™ì€ ìˆ˜ì˜ ë§ì…ˆì„ ê³„ì‚°í•´ë³´ì.",
            "ì¹ íŒ 3ì¤„": "í™œë™1 - í•™ìƒ 9ëª…ì˜ ë¬¸ì œë¥¼ ëª¨ë‘ í•´ê²°í•˜ê¸°",
            "ì¹ íŒ 4ì¤„": "í™œë™2 - ì„ ìƒë‹˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  10ì  ë§Œë“¤ê¸°",
            "ì¹ íŒ 5ì¤„": "í™œë™3 - ì¹ íŒì˜ ë‚´ìš©ì´ ë³´ì´ë„ë¡ ì‚¬ì§„ ì°ê¸°",
            "ì„ ìƒë‹˜ ì´ë¦„": "ì¡°ê¸°ì„ ì„ ìƒë‹˜",
            "í•™ìƒ1 ì´ë¦„": "í•™ìƒ1",
            "í•™ìƒ2 ì´ë¦„": "í•™ìƒ2",
            "í•™ìƒ3 ì´ë¦„": "í•™ìƒ3",
            "í•™ìƒ4 ì´ë¦„": "í•™ìƒ4",
            "í•™ìƒ5 ì´ë¦„": "í•™ìƒ5",
            "í•™ìƒ6 ì´ë¦„": "í•™ìƒ6",
            "í•™ìƒ7 ì´ë¦„": "í•™ìƒ7",
            "í•™ìƒ8 ì´ë¦„": "í•™ìƒ8",
            "í•™ìƒ9 ì´ë¦„": "í•™ìƒ9",
            "ì„ ìƒë‹˜ ë¬¸ì œ": "10+10=?",
            "ì„ ìƒë‹˜ ì •ë‹µ": "20",
            "í•™ìƒ1 ë¬¸ì œ": "1+1=?",
            "í•™ìƒ1 ì •ë‹µ": "2",
            "í•™ìƒ2 ë¬¸ì œ": "2+2=?",
            "í•™ìƒ2 ì •ë‹µ": "4",
            "í•™ìƒ3 ë¬¸ì œ": "3+3=?",
            "í•™ìƒ3 ì •ë‹µ": "6",
            "í•™ìƒ4 ë¬¸ì œ": "4+4=?",
            "í•™ìƒ4 ì •ë‹µ": "8",
            "í•™ìƒ5 ë¬¸ì œ": "5+5=?",
            "í•™ìƒ5 ì •ë‹µ": "10",
            "í•™ìƒ6 ë¬¸ì œ": "6+6=?",
            "í•™ìƒ6 ì •ë‹µ": "12",
            "í•™ìƒ7 ë¬¸ì œ": "7+7=?",
            "í•™ìƒ7 ì •ë‹µ": "14",
            "í•™ìƒ8 ë¬¸ì œ": "8+8=?",
            "í•™ìƒ8 ì •ë‹µ": "16",
            "í•™ìƒ9 ë¬¸ì œ": "9+9=?",
            "í•™ìƒ9 ì •ë‹µ": "18"
        };
        
        // ë°ì´í„° íŒŒì‹± í•¨ìˆ˜ (Google Sheetsì™€ ê¸°ë³¸ ë°ì´í„° ê³µí†µ ì‚¬ìš©)
        function parseData(dataMap) {
            console.log('=== parseData ì‹œì‘ ===');
            console.log('ì…ë ¥ dataMap:', dataMap);
            
            // ì¹ íŒ ì •ë³´ ì¶”ì¶œ (ì¹ íŒ 1-5ì¤„)
            boardInfo = {
                line1: dataMap['ì¹ íŒ 1ì¤„'] || dataMap['ì§ˆë¬¸ 1ì¤„'] || 'ì¹ íŒ 1ì¤„',
                line2: dataMap['ì¹ íŒ 2ì¤„'] || dataMap['ì§ˆë¬¸ 2ì¤„'] || 'ì¹ íŒ 2ì¤„',
                line3: dataMap['ì¹ íŒ 3ì¤„'] || dataMap['ì§ˆë¬¸ 3ì¤„'] || 'ì¹ íŒ 3ì¤„',
                line4: dataMap['ì¹ íŒ 4ì¤„'] || dataMap['ì§ˆë¬¸ 4ì¤„'] || 'ì¹ íŒ 4ì¤„',
                line5: dataMap['ì¹ íŒ 5ì¤„'] || dataMap['ì§ˆë¬¸ 5ì¤„'] || 'ì¹ íŒ 5ì¤„'
            };
            
            console.log('ì¹ íŒ ì •ë³´:', boardInfo);
            
            // ìºë¦­í„° ì´ë¦„ ì¶”ì¶œ (ì „ì—­ ë³€ìˆ˜ì— ì €ì¥)
            characterNames = {
                'ì„ ìƒë‹˜': dataMap['ì„ ìƒë‹˜ ì´ë¦„'] || 'ì„ ìƒë‹˜',
                'í•™ìƒ1': dataMap['í•™ìƒ1 ì´ë¦„'] || 'í•™ìƒ1',
                'í•™ìƒ2': dataMap['í•™ìƒ2 ì´ë¦„'] || 'í•™ìƒ2',
                'í•™ìƒ3': dataMap['í•™ìƒ3 ì´ë¦„'] || 'í•™ìƒ3',
                'í•™ìƒ4': dataMap['í•™ìƒ4 ì´ë¦„'] || 'í•™ìƒ4',
                'í•™ìƒ5': dataMap['í•™ìƒ5 ì´ë¦„'] || 'í•™ìƒ5',
                'í•™ìƒ6': dataMap['í•™ìƒ6 ì´ë¦„'] || 'í•™ìƒ6',
                'í•™ìƒ7': dataMap['í•™ìƒ7 ì´ë¦„'] || 'í•™ìƒ7',
                'í•™ìƒ8': dataMap['í•™ìƒ8 ì´ë¦„'] || 'í•™ìƒ8',
                'í•™ìƒ9': dataMap['í•™ìƒ9 ì´ë¦„'] || 'í•™ìƒ9'
            };
            
            console.log('ìºë¦­í„° ì´ë¦„:', characterNames);
            
            // í€´ì¦ˆ ë°ì´í„° ì´ˆê¸°í™”
            quizData = [];
            characterQuizMap = {};
            
            // ë¬¸ì œ/ì •ë‹µ ì¶”ì¶œ
            for (const [key, name] of Object.entries(characterNames)) {
                const question = dataMap[`${key} ë¬¸ì œ`];
                const answer = dataMap[`${key} ì •ë‹µ`];
                
                if (question && answer) {
                    const quiz = {
                        character: key,  // "ì„ ìƒë‹˜", "í•™ìƒ1" ë“±
                        characterName: name,  // "ì¡°ê¸°ì„ ì„ ìƒë‹˜", "í•™ìƒ1" ë“±
                        question: question,
                        answer: String(answer).replace('.0', '') // .0 ì œê±°
                    };
                    
                    quizData.push(quiz);
                    
                    // í‚¤("ì„ ìƒë‹˜", "í•™ìƒ1" ë“±)ë¡œ ì €ì¥
                    if (!characterQuizMap[key]) {
                        characterQuizMap[key] = [];
                    }
                    characterQuizMap[key].push(quiz);
                }
            }
            
            console.log('=== parseData ì™„ë£Œ ===');
        }
        
        // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadQuizData() {
            const sheetId = '1GH3AT-sn_7S0bkvYNPgm-kdR7cX3-gkyd1p7zwvxOfc';
            const gid = '0'; // ì²«ë²ˆì§¸ ì‹œíŠ¸
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
            
            const loadingBar = document.getElementById('loading-bar');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingBar.style.width = '30%';
                loadingStatus.textContent = 'ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...';
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                loadingBar.style.width = '60%';
                loadingStatus.textContent = 'ë°ì´í„° íŒŒì‹± ì¤‘...';
                
                // CSV íŒŒì‹±
                const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
                
                console.log('ì „ì²´ ë¼ì¸ ìˆ˜:', lines.length);
                console.log('ì²« 10ì¤„:', lines.slice(0, 10));
                
                // ë°ì´í„° êµ¬ì¡° íŒŒì‹±
                const dataMap = {};
                
                for (let i = 0; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 2) {
                        const key = values[0].replace(/"/g, '').trim();
                        const value = values[1].replace(/"/g, '').trim();
                        dataMap[key] = value;
                    }
                }
                
                console.log('íŒŒì‹±ëœ ë°ì´í„°:', dataMap);
                
                // parseData í•¨ìˆ˜ë¡œ ë°ì´í„° ì²˜ë¦¬
                parseData(dataMap);
                
                loadingBar.style.width = '100%';
                loadingStatus.textContent = 'Google Sheets ë¡œë”© ì™„ë£Œ!';
                
                console.log('í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', quizData.length, 'ê°œ');
                console.log('ìºë¦­í„°ë³„ ë°ì´í„°:', characterQuizMap);
                console.log('ì¹ íŒ ì •ë³´:', boardInfo);
                
                // ì¹ íŒ ì—…ë°ì´íŠ¸
                updateBlackboard(boardInfo);
                
                // ìºë¦­í„° ì´ë¦„ ì—…ë°ì´íŠ¸
                updateCharacterNames();
                
                // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
                
                return true;
            } catch (error) {
                console.error('Google Sheets ë¡œë“œ ì‹¤íŒ¨:', error);
                console.log('ê¸°ë³¸ ë°ì´í„°ë¡œ ì „í™˜í•©ë‹ˆë‹¤...');
                
                loadingBar.style.width = '60%';
                loadingStatus.innerHTML = `Google Sheets ë¡œë“œ ì‹¤íŒ¨<br><small>ê¸°ë³¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤</small>`;
                loadingStatus.style.color = '#ffa500';
                
                // ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©
                parseData(defaultData);
                
                loadingBar.style.width = '100%';
                loadingBar.style.background = '#ffa500';
                loadingStatus.textContent = 'ê¸°ë³¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!';
                
                console.log('ê¸°ë³¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', quizData.length, 'ê°œ');
                console.log('ìºë¦­í„°ë³„ ë°ì´í„°:', characterQuizMap);
                console.log('ì¹ íŒ ì •ë³´:', boardInfo);
                
                // ì¹ íŒ ì—…ë°ì´íŠ¸
                updateBlackboard(boardInfo);
                
                // ìºë¦­í„° ì´ë¦„ ì—…ë°ì´íŠ¸
                updateCharacterNames();
                
                // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 1000);
                
                return true;
            }
        }
        
        // CSV ë¼ì¸ íŒŒì‹± í•¨ìˆ˜ (ë”°ì˜´í‘œ ì²˜ë¦¬)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // ë°ì€ í•˜ëŠ˜ìƒ‰
        scene.fog = new THREE.Fog(0xf5f5f5, 10, 50); // ì›ë˜ ì•ˆê°œ ìƒ‰ìƒ
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.25, 5);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            preserveDrawingBuffer: true  // ìŠ¤í¬ë¦°ìƒ·ì„ ìœ„í•´ í•„ìš”
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(10, 15, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.near = 0.1;
        directionalLight.shadow.camera.far = 50;
        directionalLight.shadow.camera.left = -30;
        directionalLight.shadow.camera.right = 30;
        directionalLight.shadow.camera.top = 30;
        directionalLight.shadow.camera.bottom = -30;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.radius = 3; // ê·¸ë¦¼ì ë¸”ëŸ¬ ì ìš©
        scene.add(directionalLight);
        
        // Floor with pattern
        const floorGeometry = new THREE.PlaneGeometry(40, 40);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xdcdcdc,
            roughness: 0.7,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        
        // Add floor tiles pattern
        const tileGeometry = new THREE.PlaneGeometry(2, 2);
        const tileMaterial1 = new THREE.MeshStandardMaterial({ color: 0xc19a6b }); // ë°ì€ ê°ˆìƒ‰
        const tileMaterial2 = new THREE.MeshStandardMaterial({ color: 0xd2b48c }); // ì—°í•œ ê°ˆìƒ‰
        
        for (let x = -20; x < 20; x += 2) {
            for (let z = -20; z < 20; z += 2) {
                const tile = new THREE.Mesh(tileGeometry, ((x + z) / 2) % 2 === 0 ? tileMaterial1 : tileMaterial2);
                tile.position.set(x + 1, 0.01, z + 1);
                tile.rotation.x = -Math.PI / 2;
                tile.receiveShadow = true;
                scene.add(tile);
            }
        }
        
        // Walls with windows
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xfafafa, // ë” ë°ì€ íšŒìƒ‰
            roughness: 0.9
        });
        
        const wallThickness = 0.3; // ë²½ ë‘ê»˜
        
        // Back wall (no windows)
        const backWall = new THREE.Mesh(
            new THREE.BoxGeometry(40, 5, wallThickness),
            wallMaterial
        );
        backWall.position.set(0, 2.5, -20);
        backWall.receiveShadow = true;
        backWall.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(backWall);
        
        // Front wall (no windows)
        const frontWall = new THREE.Mesh(
            new THREE.BoxGeometry(40, 5, wallThickness),
            wallMaterial
        );
        frontWall.position.set(0, 2.5, 20);
        frontWall.receiveShadow = true;
        frontWall.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(frontWall);
        
        // Left wall with window holes (ì„œìª½ ë²½)
        // ìœ„ìª½ ë²½ (ì²œì¥ ì•„ë˜)
        const leftWallTop = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        leftWallTop.position.set(-20, 4.5, 0);
        leftWallTop.receiveShadow = true;
        leftWallTop.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(leftWallTop);
        
        // ì•„ë˜ìª½ ë²½ (ë°”ë‹¥ë¶€í„° ì‹œì‘)
        const leftWallBottom = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        leftWallBottom.position.set(-20, 0.5, 0);
        leftWallBottom.receiveShadow = true;
        leftWallBottom.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(leftWallBottom);
        
        // ì°½ë¬¸ ì‚¬ì´ ë²½ ì¡°ê°ë“¤ (ì¤‘ê°„ ë†’ì´ 3)
        // ì°½ë¬¸ ìœ„ì¹˜: z = -15, -5, 5, 15 (ê° í¬ê¸° 6x3, ì¦‰ zÂ±3 ë²”ìœ„)
        // ì°½ë¬¸1: z=-18~-12, ì°½ë¬¸2: z=-8~-2, ì°½ë¬¸3: z=2~8, ì°½ë¬¸4: z=12~18
        const leftWallSegments = [
            { z: -19, width: 2 },     // ë¶ìª½ ë (z=-20~-18)
            { z: -10, width: 4 },     // 1-2ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=-12~-8)
            { z: 0, width: 4 },       // 2-3ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=-2~2)
            { z: 10, width: 4 },      // 3-4ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=8~12)
            { z: 19, width: 2 }       // ë‚¨ìª½ ë (z=18~20)
        ];
        
        leftWallSegments.forEach(seg => {
            const wallPiece = new THREE.Mesh(
                new THREE.BoxGeometry(wallThickness, 3, seg.width),
                wallMaterial
            );
            wallPiece.position.set(-20, 2.5, seg.z);
            wallPiece.receiveShadow = true;
            wallPiece.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
            scene.add(wallPiece);
        });
        
        // Right wall with window holes (ë™ìª½ ë²½)
        // ìœ„ìª½ ë²½
        const rightWallTop = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        rightWallTop.position.set(20, 4.5, 0);
        rightWallTop.receiveShadow = true;
        rightWallTop.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(rightWallTop);
        
        // ì•„ë˜ìª½ ë²½ (ë°”ë‹¥ë¶€í„° ì‹œì‘)
        const rightWallBottom = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        rightWallBottom.position.set(20, 0.5, 0);
        rightWallBottom.receiveShadow = true;
        rightWallBottom.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
        scene.add(rightWallBottom);
        
        // ì°½ë¬¸ ì‚¬ì´ ë²½ ì¡°ê°ë“¤
        const rightWallSegments = [
            { z: -19, width: 2 },     // ë¶ìª½ ë (z=-20~-18)
            { z: -10, width: 4 },     // 1-2ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=-12~-8)
            { z: 0, width: 4 },       // 2-3ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=-2~2)
            { z: 10, width: 4 },      // 3-4ë²ˆ ì°½ë¬¸ ì‚¬ì´ (z=8~12)
            { z: 19, width: 2 }       // ë‚¨ìª½ ë (z=18~20)
        ];
        
        rightWallSegments.forEach(seg => {
            const wallPiece = new THREE.Mesh(
                new THREE.BoxGeometry(wallThickness, 3, seg.width),
                wallMaterial
            );
            wallPiece.position.set(20, 2.5, seg.z);
            wallPiece.receiveShadow = true;
            wallPiece.castShadow = false; // ê·¸ë¦¼ì ìƒì„± ë¹„í™œì„±í™”
            scene.add(wallPiece);
        });
        
        // Office furniture
        const woodMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xb4e7ce, // íŒŒìŠ¤í…” ë…¹ìƒ‰
            roughness: 0.6,
            metalness: 0.1
        });
        
        const metalMaterial = new THREE.MeshStandardMaterial({
            color: 0x808080, // íšŒìƒ‰
            roughness: 0.3,
            metalness: 0.8
        });
        
        const lightGreyMaterial = new THREE.MeshStandardMaterial({
            color: 0xffffff, // í°ìƒ‰ (ê°€ì¥ ë°ê²Œ)
            roughness: 0.3,
            metalness: 0.5
        });
        
        // Create detailed desks
        function createDesk(x, z) {
            const deskGroup = new THREE.Group();
            
            // Desk top
            const deskTop = new THREE.Mesh(
                new THREE.BoxGeometry(3, 0.1, 1.5),
                woodMaterial
            );
            deskTop.position.y = 0.75;
            deskTop.castShadow = true;
            deskTop.receiveShadow = true;
            deskGroup.add(deskTop);
            
            // Metal frame
            const frameGeometry = new THREE.BoxGeometry(0.05, 0.7, 0.05);
            const framePositions = [
                [-1.45, 0.35, -0.7],
                [1.45, 0.35, -0.7],
                [-1.45, 0.35, 0.7],
                [1.45, 0.35, 0.7]
            ];
            
            framePositions.forEach(pos => {
                const frame = new THREE.Mesh(frameGeometry, metalMaterial);
                frame.position.set(...pos);
                frame.castShadow = true;
                deskGroup.add(frame);
            });
            
            // Computer monitor base
            const monitorBase = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 0.05, 16),
                lightGreyMaterial
            );
            monitorBase.position.set(0, 0.82, 0);
            monitorBase.castShadow = true;
            monitorBase.receiveShadow = true;
            deskGroup.add(monitorBase);
            
            const monitorStand = new THREE.Mesh(
                new THREE.BoxGeometry(0.05, 0.3, 0.05),
                lightGreyMaterial
            );
            monitorStand.position.set(0, 0.97, 0);
            monitorStand.castShadow = true;
            monitorStand.receiveShadow = true;
            deskGroup.add(monitorStand);
            
            // Monitor body (ë°ì€ íšŒìƒ‰)
            const monitorBody = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 0.7, 0.05),
                lightGreyMaterial
            );
            monitorBody.position.set(0, 1.3, 0);
            monitorBody.castShadow = true;
            monitorBody.receiveShadow = true;
            deskGroup.add(monitorBody);
            
            // Monitor screen (ê²€ì •ìƒ‰ ì•¡ì •)
            const monitorScreen = new THREE.Mesh(
                new THREE.BoxGeometry(1.1, 0.6, 0.02),
                new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.1, metalness: 0.5 })
            );
            monitorScreen.position.set(0, 1.3, 0.035);
            monitorScreen.castShadow = true;
            monitorScreen.receiveShadow = true;
            deskGroup.add(monitorScreen);
            
            // ì´ëª¨ì§€ í‘œì‹œìš© ë©”ì‹œ ì €ì¥
            deskGroup.userData.monitorScreen = monitorScreen;
            deskGroup.userData.emojiMesh = null; // ë‚˜ì¤‘ì— ì´ëª¨ì§€ ë©”ì‹œ ì €ì¥
            
            // Keyboard (ê°€ë¡œ 2ë°°, ìœ„ì¹˜ ì¡°ì •)
            const keyboard = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.02, 0.15),
                lightGreyMaterial
            );
            keyboard.position.set(0, 0.81, 0.5);
            keyboard.castShadow = true;
            keyboard.receiveShadow = true;
            deskGroup.add(keyboard);
            
            deskGroup.position.set(x, 0, z);
            return deskGroup;
        }
        
        // ì±…ìƒ ëª¨ë‹ˆí„°ì— ì´ëª¨ì§€ í‘œì‹œ í•¨ìˆ˜
        function showEmojiOnDesk(deskX, deskZ, emoji) {
            // í•´ë‹¹ ìœ„ì¹˜ì˜ ì±…ìƒ ì°¾ê¸°
            const desk = desks.find(d => 
                Math.abs(d.position.x - deskX) < 0.1 && 
                Math.abs(d.position.z - deskZ) < 0.1
            );
            
            if (!desk) return;
            
            // ê¸°ì¡´ ì´ëª¨ì§€ ì œê±°
            if (desk.userData.emojiMesh) {
                desk.remove(desk.userData.emojiMesh);
            }
            
            // ìº”ë²„ìŠ¤ì— ì´ëª¨ì§€ ê·¸ë¦¬ê¸°
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.font = 'bold 180px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, canvas.width / 2, canvas.height / 2);
            
            // í…ìŠ¤ì²˜ ìƒì„±
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture,
                transparent: true
            });
            
            // ëª¨ë‹ˆí„° í™”ë©´ í¬ê¸°ì— ë§ê²Œ ë©”ì‹œ ìƒì„±
            const emojiMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(1.1, 0.6),
                material
            );
            emojiMesh.position.set(0, 1.3, 0.055); // ëª¨ë‹ˆí„° ìŠ¤í¬ë¦° ì•
            desk.add(emojiMesh);
            desk.userData.emojiMesh = emojiMesh;
        }
        
        // Add desks
        const desk1 = createDesk(-10, -10);
        const desk2 = createDesk(0, -10);
        const desk3 = createDesk(10, -10);
        const desk4 = createDesk(-10, 0);
        const desk5 = createDesk(0, 0);
        const desk6 = createDesk(10, 0);
        const desk7 = createDesk(-10, 10);
        const desk8 = createDesk(0, 10);
        const desk9 = createDesk(10, 10);
        scene.add(desk1, desk2, desk3, desk4, desk5, desk6, desk7, desk8, desk9);
        
        // ì±…ìƒ ë°°ì—´ (ì¶©ëŒ ê°ì§€ìš©)
        const desks = [desk1, desk2, desk3, desk4, desk5, desk6, desk7, desk8, desk9];
        
        // Add whiteboards with funny drawings
        const blackboardMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x1a1a1a, // ê²€ì •ìƒ‰ (ì•½ê°„ ë°ê²Œ)
            roughness: 0.8,
            metalness: 0.1
        });
        
        const blackboard = new THREE.Mesh(
            new THREE.BoxGeometry(9, 3, 0.1),
            blackboardMaterial
        );
        blackboard.position.set(0, 2.5, -19.8);
        blackboard.castShadow = true;
        scene.add(blackboard);
        
        // ì¹ íŒ í…ìŠ¤íŠ¸ ë©”ì‹œ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸)
        let blackboardWithText = null;
        
        // ì¹ íŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateBlackboard(info) {
            // ê¸°ì¡´ ì¹ íŒ í…ìŠ¤íŠ¸ ì œê±°
            if (blackboardWithText) {
                scene.remove(blackboardWithText);
            }
            
            // ì¹ íŒì— í…ìŠ¤íŠ¸ ì¶”ê°€
            const blackboardCanvas = document.createElement('canvas');
            blackboardCanvas.width = 2048;
            blackboardCanvas.height = 1024;
            const blackboardCtx = blackboardCanvas.getContext('2d');
            
            // ë°°ê²½ (ì¹ íŒ ìƒ‰ìƒ)
            blackboardCtx.fillStyle = '#1a1a1a';
            blackboardCtx.fillRect(0, 0, blackboardCanvas.width, blackboardCanvas.height);
            
            // í…ìŠ¤íŠ¸ ì„¤ì •
            blackboardCtx.textAlign = 'center';
            blackboardCtx.textBaseline = 'middle';
            
            // 1ì¤„: ë‹¨ì›ëª… (í°ìƒ‰, í° í°íŠ¸)
            blackboardCtx.fillStyle = '#ffffff';
            blackboardCtx.font = 'bold 100px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line1, blackboardCanvas.width / 2, 180);
            
            // 2ì¤„: í•™ìŠµì£¼ì œ (ë…¸ë€ìƒ‰, í° í°íŠ¸)
            blackboardCtx.fillStyle = '#ffeb3b';
            blackboardCtx.font = 'bold 80px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line2, blackboardCanvas.width / 2, 320);
            
            // 3-4-5ì¤„: í™œë™ (í°ìƒ‰, ì‘ì€ í°íŠ¸)
            blackboardCtx.fillStyle = '#ffffff';
            blackboardCtx.font = '60px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line3, blackboardCanvas.width / 2, 520);
            blackboardCtx.fillText(info.line4, blackboardCanvas.width / 2, 650);
            blackboardCtx.fillText(info.line5, blackboardCanvas.width / 2, 780);
            
            // í…ìŠ¤ì²˜ ìƒì„± ë° ì ìš©
            const blackboardTexture = new THREE.CanvasTexture(blackboardCanvas);
            const blackboardTextMaterial = new THREE.MeshStandardMaterial({ 
                map: blackboardTexture,
                roughness: 0.8,
                metalness: 0.1
            });
            
            blackboardWithText = new THREE.Mesh(
                new THREE.BoxGeometry(9, 3, 0.1),
                blackboardTextMaterial
            );
            blackboardWithText.position.set(0, 2.5, -19.79); // ì¹ íŒë³´ë‹¤ ì•½ê°„ ì•ìœ¼ë¡œ
            scene.add(blackboardWithText);
        }
        
        // ìºë¦­í„° ì´ë¦„ ë¼ë²¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCharacterNames() {
            console.log('=== updateCharacterNames ì‹œì‘ ===');
            console.log('characters ë°°ì—´ ê¸¸ì´:', characters.length);
            console.log('characterNames:', characterNames);
            
            characters.forEach((character, index) => {
                const key = character.userData.name; // 'ì„ ìƒë‹˜', 'í•™ìƒ1' ë“±
                const displayName = characterNames[key] || key;
                
                console.log(`ìºë¦­í„° ${index}: key=${key}, displayName=${displayName}`);
                
                // ìºë¦­í„° ê·¸ë£¹ì—ì„œ ë¼ë²¨(Sprite) ì°¾ê¸°
                const label = character.children.find(child => child instanceof THREE.Sprite);
                
                if (label) {
                    console.log(`  â†’ ë¼ë²¨ ë°œê²¬, ì—…ë°ì´íŠ¸ ì¤‘: ${displayName}`);
                    
                    // ìƒˆë¡œìš´ ìº”ë²„ìŠ¤ë¡œ ë¼ë²¨ í…ìŠ¤ì²˜ ì¬ìƒì„±
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    // ì´ë¦„ ê¸¸ì´ ì¸¡ì •
                    context.font = 'bold 24px "Noto Sans KR", sans-serif';
                    const nameWidth = context.measureText(displayName).width;
                    const padding = 20;
                    const canvasWidth = Math.max(nameWidth + padding * 2, 100);
                    const canvasHeight = 50;
                    
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    
                    // ë°°ê²½ (í°ìƒ‰ ë°˜íˆ¬ëª…)
                    context.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    context.fillRect(0, 0, canvasWidth, canvasHeight);
                    
                    // ì´ë¦„ í…ìŠ¤íŠ¸ (ê°€ìš´ë° ì •ë ¬)
                    context.fillStyle = 'black';
                    context.font = 'bold 24px "Noto Sans KR", sans-serif';
                    context.textAlign = 'center';
                    context.textBaseline = 'middle';
                    context.fillText(displayName, canvasWidth / 2, canvasHeight / 2);
                    
                    // í…ìŠ¤ì²˜ ì—…ë°ì´íŠ¸
                    const texture = new THREE.CanvasTexture(canvas);
                    label.material.map.dispose(); // ê¸°ì¡´ í…ìŠ¤ì²˜ ë©”ëª¨ë¦¬ í•´ì œ
                    label.material.map = texture;
                    label.material.needsUpdate = true;
                    
                    // ë¼ë²¨ í¬ê¸° ì¡°ì •
                    const labelWidth = canvasWidth / 128;
                    const labelHeight = canvasHeight / 128;
                    label.scale.set(labelWidth, labelHeight, 1);
                } else {
                    console.log(`  â†’ ë¼ë²¨ ì—†ìŒ`);
                }
            });
            
            console.log('=== updateCharacterNames ì™„ë£Œ ===');
        }
        
        // ì´ˆê¸° ì¹ íŒ (ë°ì´í„° ë¡œë“œ ì „)
        updateBlackboard({
            line1: 'ë°ì´í„° ë¡œë”© ì¤‘...',
            line2: '',
            line3: '',
            line4: '',
            line5: ''
        });
        
        // Character creation with more detail
        const characters = [];
        
        function createCharacter(name, role, x, z, shirtColor, characterData) {
            const group = new THREE.Group();
            
            // Torso
            const torsoGeometry = new THREE.CylinderGeometry(0.23, 0.3, 0.6, 8);
            const torsoMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const torso = new THREE.Mesh(torsoGeometry, torsoMaterial);
            torso.position.y = 0.7;
            torso.castShadow = true;
            group.add(torso);
            
            // Arms (ì–´ê¹¨ì—ì„œ íšŒì „í•˜ë„ë¡ ì„¤ì •)
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 6);
            const armMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            
            // íŒ”ì„ ì»¨í…Œì´ë„ˆì— ë„£ì–´ì„œ íšŒì „ ì¤‘ì‹¬ì„ ì–´ê¹¨ë¡œ ì„¤ì •
            const leftArmContainer = new THREE.Group();
            leftArmContainer.position.set(-0.28, 1.0, 0); // ëª¸í†µ ìª½ìœ¼ë¡œ ì´ë™ (-0.33 â†’ -0.28)
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.y = -0.3; // íŒ”ì„ ì•„ë˜ë¡œ ì˜¤í”„ì…‹ (íšŒì „ ì¤‘ì‹¬ì´ ìœ„ì— ìˆë„ë¡)
            leftArm.castShadow = true;
            leftArmContainer.add(leftArm);
            leftArmContainer.rotation.z = -Math.PI / 12; // 15ë„ ë²Œì–´ì§ (180/12 = 15)
            group.add(leftArmContainer);
            
            const rightArmContainer = new THREE.Group();
            rightArmContainer.position.set(0.28, 1.0, 0); // ëª¸í†µ ìª½ìœ¼ë¡œ ì´ë™ (0.33 â†’ 0.28)
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.y = -0.3; // íŒ”ì„ ì•„ë˜ë¡œ ì˜¤í”„ì…‹ (íšŒì „ ì¤‘ì‹¬ì´ ìœ„ì— ìˆë„ë¡)
            rightArm.castShadow = true;
            rightArmContainer.add(rightArm);
            rightArmContainer.rotation.z = Math.PI / 12; // 15ë„ ë²Œì–´ì§ (180/12 = 15)
            group.add(rightArmContainer);
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.6, 6);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, 0.3, 0);
            group.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, 0.3, 0);
            group.add(rightLeg);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25, 8, 6);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffe4c4 }); // ë” ë°ì€ í”¼ë¶€ìƒ‰ (Bisque)
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.25;
            head.castShadow = true;
            group.add(head);
            
            // Hair
            const hairGeometry = new THREE.SphereGeometry(0.27, 8, 6);
            const hairMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.y = 1.38; // 0.03 ìœ„ë¡œ ì´ë™ (1.35 â†’ 1.38)
            hair.scale.y = 0.6;
            group.add(hair);
            
            // Eyes
            const eyeGeometry = new THREE.SphereGeometry(0.03, 4, 4);
            const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.08, 1.25, 0.22);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.08, 1.25, 0.22);
            group.add(rightEye);
            
            // Name label
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // ì´ë¦„ ê¸¸ì´ ì¸¡ì •
            context.font = 'bold 24px "Noto Sans KR", sans-serif';
            const nameWidth = context.measureText(name).width;
            const padding = 20; // ì¢Œìš° ì—¬ë°±
            const canvasWidth = Math.max(nameWidth + padding * 2, 100); // ìµœì†Œ í­ 100
            const canvasHeight = 50;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // ë°°ê²½ (í°ìƒ‰ ë°˜íˆ¬ëª…)
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // ì´ë¦„ í…ìŠ¤íŠ¸ (ê°€ìš´ë° ì •ë ¬)
            context.fillStyle = 'black';
            context.font = 'bold 24px "Noto Sans KR", sans-serif';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(name, canvasWidth / 2, canvasHeight / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            
            // ë¨¸ë¦¬ì¹´ë½ ì œì¼ ìœ—ë¶€ë¶„ì—ì„œ 0.1 ìœ„ + 0.2 ì¶”ê°€ ìƒìŠ¹
            // ë¨¸ë¦¬ì¹´ë½ ì¤‘ì‹¬: y = 1.38, ë°˜ì§€ë¦„: 0.27, y scale: 0.6
            // ì œì¼ ìœ—ë¶€ë¶„: 1.38 + (0.27 * 0.6) = 1.542
            label.position.y = 1.542 + 0.1 + 0.2; // 1.842
            
            // ë¼ë²¨ í¬ê¸°ë¥¼ ì´ë¦„ ê¸¸ì´ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì ˆ
            const labelWidth = canvasWidth / 128; // ê¸°ë³¸ ë¹„ìœ¨ ì¡°ì •
            const labelHeight = canvasHeight / 128;
            label.scale.set(labelWidth, labelHeight, 1);
            
            group.add(label);
            
            group.position.set(x, 0, z);
            
            // ë¶ìª½(z=-20 ë°©í–¥)ì„ ë°”ë¼ë³´ë„ë¡ 180ë„ íšŒì „
            group.rotation.y = Math.PI;
            
            group.userData = { 
                name, 
                role, 
                conversations: [],
                initialPosition: new THREE.Vector3(x, 0, z),
                initialized: false, // ìµœì´ˆ ë°©í–¥ ì„¤ì • ì—¬ë¶€
                stopUntil: null, // ì •ì§€ ì‹œê°„ (í”Œë ˆì´ì–´ ì¶©ëŒ ì‹œ)
                speed: 2.5, // ì´ë™ ì†ë„
                isDancing: false,
                hasCoffee: Math.random() > 0.5,
                stuckInDoor: false,
                tripChance: 0.001,
                leftArm: leftArmContainer, // ì»¨í…Œì´ë„ˆ ì°¸ì¡°
                rightArm: rightArmContainer, // ì»¨í…Œì´ë„ˆ ì°¸ì¡°
                ...characterData
            };
            
            characters.push(group);
            return group;
        }
        
        // í•™ìƒ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì¤‘ê°„ ì±„ë„ì˜ ë¶€ë“œëŸ¬ìš´ í†¤ 9ìƒ‰)
        const studentColors = [
            0xe8e8e8, // ë°ì€ íšŒìƒ‰ (ë¶€ë“œëŸ¬ìš´ í°ìƒ‰)
            0xff6b6b, // ì½”ë„ ë ˆë“œ (ì ë‹¹í•œ ë¹¨ê°•)
            0x4dabf7, // ë°ì€ ë¸”ë£¨ (ì ë‹¹í•œ íŒŒë‘)
            0xffd43b, // ì„ ìƒ¤ì¸ ì˜ë¡œìš° (ì ë‹¹í•œ ë…¸ë‘)
            0x51cf66, // ë¯¼íŠ¸ ê·¸ë¦° (ì ë‹¹í•œ ì´ˆë¡)
            0xff922b, // íƒ ì €ë¦° (ì ë‹¹í•œ ì˜¤ë Œì§€)
            0x9775fa, // ë°”ì´ì˜¬ë › (ì ë‹¹í•œ ë³´ë¼)
            0xff6b9d, // ë¡œì¦ˆ í•‘í¬ (ì ë‹¹í•œ í•‘í¬)
            0x3bc9db  // ì‹œì•ˆ ë¸”ë£¨ (ì ë‹¹í•œ í•˜ëŠ˜ìƒ‰)
        ];
        
        // ë°°ì—´ ì„ê¸° í•¨ìˆ˜ (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // í•™ìƒ ìƒ‰ìƒ ëœë¤ ì„ê¸°
        const shuffledColors = shuffleArray(studentColors);
        
        // Add characters with varied appearances and quirks
        // ì„ ìƒë‹˜: í™”ì´íŠ¸ë³´ë“œ(0, 0, -19.8)ì—ì„œ ë‚¨ìª½(Z+)ìœ¼ë¡œ 5
        // ì•„ì£¼ ì§„í•œ íšŒìƒ‰
        const teacher = createCharacter('ì„ ìƒë‹˜', '', 0, -14.8, 0x404040, {
            hairColor: 0x404040
        });
        teacher.userData.originalPosition = { x: 0, z: -14.8 };
        teacher.userData.completed = false;
        teacher.userData.deskPosition = null; // ì„ ìƒë‹˜ì€ ì±…ìƒì´ ì—†ìŒ
        teacher.userData.name = 'ì„ ìƒë‹˜'; // í‚¤ ì €ì¥
        
        // í•™ìƒë“¤: ê° ì±…ìƒì—ì„œ ë‚¨ìª½(Z+)ìœ¼ë¡œ 2
        // ëœë¤ ìƒ‰ìƒ ì ìš© (9ëª…ì—ê²Œ 9ê°€ì§€ ìƒ‰ìƒì„ ì¤‘ë³µ ì—†ì´ ë°°ì •)
        // ì±…ìƒ1: (-10, -10) â†’ í•™ìƒ1: (-10, -8)
        const student1 = createCharacter('í•™ìƒ1', '', -10, -8, shuffledColors[0], {
            hairColor: shuffledColors[0]
        });
        student1.userData.originalPosition = { x: -10, z: -8 };
        student1.userData.completed = false;
        student1.userData.deskPosition = { x: -10, z: -10 };
        student1.userData.name = 'í•™ìƒ1'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ2: (0, -10) â†’ í•™ìƒ2: (0, -8)
        const student2 = createCharacter('í•™ìƒ2', '', 0, -8, shuffledColors[1], {
            hairColor: shuffledColors[1]
        });
        student2.userData.originalPosition = { x: 0, z: -8 };
        student2.userData.completed = false;
        student2.userData.deskPosition = { x: 0, z: -10 };
        student2.userData.name = 'í•™ìƒ2'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ3: (10, -10) â†’ í•™ìƒ3: (10, -8)
        const student3 = createCharacter('í•™ìƒ3', '', 10, -8, shuffledColors[2], {
            hairColor: shuffledColors[2]
        });
        student3.userData.originalPosition = { x: 10, z: -8 };
        student3.userData.completed = false;
        student3.userData.deskPosition = { x: 10, z: -10 };
        student3.userData.name = 'í•™ìƒ3'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ4: (-10, 0) â†’ í•™ìƒ4: (-10, 2)
        const student4 = createCharacter('í•™ìƒ4', '', -10, 2, shuffledColors[3], {
            hairColor: shuffledColors[3]
        });
        student4.userData.originalPosition = { x: -10, z: 2 };
        student4.userData.completed = false;
        student4.userData.deskPosition = { x: -10, z: 0 };
        student4.userData.name = 'í•™ìƒ4'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ5: (0, 0) â†’ í•™ìƒ5: (0, 2)
        const student5 = createCharacter('í•™ìƒ5', '', 0, 2, shuffledColors[4], {
            hairColor: shuffledColors[4]
        });
        student5.userData.originalPosition = { x: 0, z: 2 };
        student5.userData.completed = false;
        student5.userData.deskPosition = { x: 0, z: 0 };
        student5.userData.name = 'í•™ìƒ5'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ6: (10, 0) â†’ í•™ìƒ6: (10, 2)
        const student6 = createCharacter('í•™ìƒ6', '', 10, 2, shuffledColors[5], {
            hairColor: shuffledColors[5]
        });
        student6.userData.originalPosition = { x: 10, z: 2 };
        student6.userData.completed = false;
        student6.userData.deskPosition = { x: 10, z: 0 };
        student6.userData.name = 'í•™ìƒ6'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ7: (-10, 10) â†’ í•™ìƒ7: (-10, 12)
        const student7 = createCharacter('í•™ìƒ7', '', -10, 12, shuffledColors[6], {
            hairColor: shuffledColors[6]
        });
        student7.userData.originalPosition = { x: -10, z: 12 };
        student7.userData.completed = false;
        student7.userData.deskPosition = { x: -10, z: 10 };
        student7.userData.name = 'í•™ìƒ7'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ8: (0, 10) â†’ í•™ìƒ8: (0, 12)
        const student8 = createCharacter('í•™ìƒ8', '', 0, 12, shuffledColors[7], {
            hairColor: shuffledColors[7]
        });
        student8.userData.originalPosition = { x: 0, z: 12 };
        student8.userData.completed = false;
        student8.userData.deskPosition = { x: 0, z: 10 };
        student8.userData.name = 'í•™ìƒ8'; // í‚¤ ì €ì¥
        
        // ì±…ìƒ9: (10, 10) â†’ í•™ìƒ9: (10, 12)
        const student9 = createCharacter('í•™ìƒ9', '', 10, 12, shuffledColors[8], {
            hairColor: shuffledColors[8]
        });
        student9.userData.originalPosition = { x: 10, z: 12 };
        student9.userData.completed = false;
        student9.userData.deskPosition = { x: 10, z: 10 };
        student9.userData.name = 'í•™ìƒ9'; // í‚¤ ì €ì¥
        
        // characters ë°°ì—´ì— ëª¨ë“  ìºë¦­í„° ì¶”ê°€
        characters.push(teacher, student1, student2, student3, student4, student5, student6, student7, student8, student9);
        
        scene.add(teacher, student1, student2, student3, student4, student5, student6, student7, student8, student9);
        
        // ì„ ìƒë‹˜ í¬ê¸°ë¥¼ 130%ë¡œ ì„¤ì •
        teacher.scale.set(1.3, 1.3, 1.3);
        
        // í•™ìƒë“¤ í¬ê¸°ë¥¼ 110%ë¡œ ì„¤ì •
        [student1, student2, student3, student4, student5, student6, student7, student8, student9].forEach(character => {
            character.scale.set(1.1, 1.1, 1.1);
        });
        
        // Player controls
        // ë‚¨ìª½ ë²½ ì¤‘ì•™(0, 0, 20)ì—ì„œ ë¶ìª½ìœ¼ë¡œ 5 ì´ë™ â†’ (0, 1.6, 15)
        const player = {
            position: new THREE.Vector3(0, 1.25, 15),
            velocity: new THREE.Vector3(0, 0, 0),
            speed: 0.05, // ì†ë„ 50% ê°ì†Œ
            isDancing: false
        };
        
        // ìºë¦­í„° ì›€ì§ì„ í™œì„±í™” í”Œë˜ê·¸
        let charactersCanMove = false;
        
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            keys[e.key] = true; // Store original key for arrow keys
            
            // Prevent arrow keys from scrolling the page
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            keys[e.key] = false; // Clear original key for arrow keys
        });
        
        // UI ë²„íŠ¼ ê¸°ëŠ¥ ì„¤ì •
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
        const navButtons = {
            up: document.getElementById('nav-up'),
            down: document.getElementById('nav-down'),
            left: document.getElementById('nav-left'),
            right: document.getElementById('nav-right')
        };
        
        // ë²„íŠ¼ ëˆŒë €ì„ ë•Œ í‚¤ ìƒíƒœ ë³€ê²½
        Object.keys(navButtons).forEach(direction => {
            const button = navButtons[direction];
            const arrowKey = 'Arrow' + direction.charAt(0).toUpperCase() + direction.slice(1);
            
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            button.addEventListener('mousedown', () => {
                keys[arrowKey] = true;
            });
            button.addEventListener('mouseup', () => {
                keys[arrowKey] = false;
            });
            button.addEventListener('mouseleave', () => {
                keys[arrowKey] = false;
            });
            
            // í„°ì¹˜ ì´ë²¤íŠ¸
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys[arrowKey] = true;
            });
            button.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys[arrowKey] = false;
            });
        });
        
        // ìŠ¤í¬ë¦°ìƒ· ë²„íŠ¼
        document.getElementById('screenshot-button').addEventListener('click', () => {
            try {
                // UI ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
                const uiElements = [
                    document.getElementById('screenshot-button'),
                    document.getElementById('fullscreen-button'),
                    document.getElementById('navigation-controls'),
                    document.getElementById('progress-bar')
                ];
                
                uiElements.forEach(el => {
                    if (el) el.classList.add('hide-ui');
                });
                
                // ì ì‹œ ëŒ€ê¸° í›„ ìº¡ì²˜ (UIê°€ ì™„ì „íˆ ìˆ¨ê²¨ì§€ë„ë¡)
                setTimeout(() => {
                    const canvas = renderer.domElement;
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'êµì‹¤_ì‹œë®¬ë ˆì´í„°_' + new Date().getTime() + '.jpg';
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        // UI ìš”ì†Œë“¤ ë‹¤ì‹œ í‘œì‹œ
                        uiElements.forEach(el => {
                            if (el) el.classList.remove('hide-ui');
                        });
                    }, 'image/jpeg', 0.95);
                }, 50);
            } catch (error) {
                console.error('ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ UI ë³µêµ¬
                const uiElements = [
                    document.getElementById('screenshot-button'),
                    document.getElementById('fullscreen-button'),
                    document.getElementById('navigation-controls'),
                    document.getElementById('progress-bar')
                ];
                uiElements.forEach(el => {
                    if (el) el.classList.remove('hide-ui');
                });
            }
        });
        
        // ì „ì²´í™”ë©´ ë²„íŠ¼
        document.getElementById('fullscreen-button').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('ì „ì²´í™”ë©´ ì „í™˜ ì‹¤íŒ¨:', err);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressBar() {
            const completedCount = characters.filter(c => c.userData.completed).length;
            const progressBar = document.getElementById('progress-bar');
            
            // ìµœëŒ€ 10ì  ì œí•œ
            const score = Math.min(completedCount, 10);
            
            // ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ (1, 2, ... 10)
            progressBar.textContent = score.toString();
        }
        
        // Character movement AI with chaos
        // í—ˆìš©ëœ íšŒì „ ê°ë„ (ë¼ë””ì•ˆ)
        const allowedAngles = [-120, -90, -60, -30, 30, 60, 90, 120].map(deg => deg * Math.PI / 180);
        
        // ëœë¤ ê°ë„ ì„ íƒ í•¨ìˆ˜
        function getRandomAngle() {
            return allowedAngles[Math.floor(Math.random() * allowedAngles.length)];
        }
        
        function updateCharacterMovement(character, deltaTime) {
            // ì‚¬ìš©ìê°€ ì›€ì§ì´ê¸° ì „ê¹Œì§€ ìºë¦­í„° ì •ì§€
            if (!charactersCanMove) {
                return;
            }
            
            // ì™„ë£Œëœ ìºë¦­í„°ê°€ ì§‘ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ì¤‘
            if (character.userData.returningHome) {
                const targetPos = character.userData.targetPosition;
                const dx = targetPos.x - character.position.x;
                const dz = targetPos.z - character.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                
                // ëª©í‘œ ì§€ì ì— ë„ì°©í–ˆëŠ”ì§€ í™•ì¸ (0.1 ê±°ë¦¬ ì´ë‚´)
                if (distance < 0.1) {
                    // ì •í™•í•œ ìœ„ì¹˜ë¡œ ì„¤ì •
                    character.position.x = targetPos.x;
                    character.position.z = targetPos.z;
                    
                    // ë°©í–¥ ì„¤ì •: ì„ ìƒë‹˜ì€ ë‚¨ìª½(0), í•™ìƒì€ ë¶ìª½(Math.PI)
                    if (character.userData.name === 'ì„ ìƒë‹˜') {
                        character.rotation.y = 0; // ë‚¨ìª½
                    } else {
                        character.rotation.y = Math.PI; // ë¶ìª½
                    }
                    
                    // íŒ”ì„ ì›ë˜ ìœ„ì¹˜ë¡œ
                    character.userData.leftArm.rotation.x = 0;
                    character.userData.rightArm.rotation.x = 0;
                    
                    // ì§‘ ë„ì°© ì™„ë£Œ
                    character.userData.returningHome = false;
                    character.userData.initialized = false; // ë‹¤ì‹œ ì›€ì§ì´ì§€ ì•Šë„ë¡
                    return;
                }
                
                // ëª©í‘œ ì§€ì ì„ í–¥í•´ ì´ë™
                const moveSpeed = 1.25; // ì†ë„ 50% ê°ì†Œ
                const direction = new THREE.Vector3(dx, 0, dz).normalize();
                character.position.add(direction.multiplyScalar(moveSpeed * deltaTime));
                
                // ëª©í‘œ ì§€ì ì„ ë°”ë¼ë³´ë„ë¡ íšŒì „
                const angle = Math.atan2(dx, dz);
                character.rotation.y = angle;
                
                // ê±·ëŠ” ì• ë‹ˆë©”ì´ì…˜ (íŒ” í”ë“¤ê¸°)
                const walkSpeed = 8;
                character.userData.leftArm.rotation.x = Math.sin(Date.now() * 0.005 * walkSpeed) * 0.5;
                character.userData.rightArm.rotation.x = -Math.sin(Date.now() * 0.005 * walkSpeed) * 0.5;
                
                return;
            }
            
            // ì™„ë£Œëœ ìºë¦­í„°ëŠ” ì›€ì§ì´ì§€ ì•ŠìŒ (ì œìë¦¬ì— ì •ì§€)
            if (character.userData.completed) {
                character.userData.leftArm.rotation.x = 0;
                character.userData.rightArm.rotation.x = 0;
                return;
            }
            
            // Don't move if this character is in conversation
            if (character === currentCharacter) {
                // Face the player
                const lookTarget = new THREE.Vector3(player.position.x, character.position.y, player.position.z);
                character.lookAt(lookTarget);
                character.rotation.x = 0;
                character.rotation.z = 0;
                return;
            }
            
            // ì •ì§€ ì¤‘ì¸ ìºë¦­í„° ì²˜ë¦¬
            if (character.userData.stopUntil && Date.now() < character.userData.stopUntil) {
                // ì •ì§€ ì¤‘ì—ë„ í”Œë ˆì´ì–´ ë°©í–¥ í™•ì¸ (ê·¼ì²˜ì— ìˆìœ¼ë©´ ë°”ë¼ë³´ê¸°)
                const dx = player.position.x - character.position.x;
                const dz = player.position.z - character.position.z;
                const distanceToPlayer = Math.sqrt(dx * dx + dz * dz);
                
                if (distanceToPlayer < 2) {
                    const lookTarget = new THREE.Vector3(player.position.x, character.position.y, player.position.z);
                    character.lookAt(lookTarget);
                    character.rotation.x = 0;
                    character.rotation.z = 0;
                }
                
                // ì •ì§€ ì‹œ íŒ”ì„ ì›ë˜ ìœ„ì¹˜ë¡œ
                character.userData.leftArm.rotation.x = 0;
                character.userData.rightArm.rotation.x = 0;
                return; // ì •ì§€ ì‹œê°„ì´ ëë‚  ë•Œê¹Œì§€ ì›€ì§ì´ì§€ ì•ŠìŒ
            } else if (character.userData.stopUntil) {
                // ì •ì§€ ì‹œê°„ì´ ëë‚¬ìœ¼ë©´ ìƒˆë¡œìš´ ê°ë„ë¡œ íšŒì „
                const rotationAngle = getRandomAngle();
                character.rotation.y += rotationAngle;
                character.userData.stopUntil = null;
            }
            
            // ìµœì´ˆ ì´ë™ ì‹œ ëœë¤ ê°ë„ë¡œ ë°©í–¥ ì„¤ì •
            if (!character.userData.initialized) {
                character.rotation.y = Math.random() * Math.PI * 2; // ì´ˆê¸° ë°©í–¥ ëœë¤
                character.userData.initialized = true;
            }
            
            // ì´ë™ ì†ë„
            const moveSpeed = 1.25; // deltaTimeê³¼ í•¨ê»˜ ì‚¬ìš© (50% ê°ì†Œ)
            
            // í˜„ì¬ ë°”ë¼ë³´ëŠ” ë°©í–¥ìœ¼ë¡œ ì§ì§„
            const forwardDirection = new THREE.Vector3(
                Math.sin(character.rotation.y),
                0,
                Math.cos(character.rotation.y)
            );
            
            // ìƒˆë¡œìš´ ìœ„ì¹˜ ê³„ì‚°
            const newPosition = character.position.clone();
            newPosition.add(forwardDirection.multiplyScalar(moveSpeed * deltaTime));
            
            // ì¶©ëŒ ê°ì§€ ë³€ìˆ˜
            let collisionDetected = false;
            let playerCollision = false;
            
            // 1. ì±…ìƒê³¼ì˜ ì¶©ëŒ ê°ì§€
            const deskCollisionDistance = 2.0;
            for (let desk of desks) {
                const dx = newPosition.x - desk.position.x;
                const dz = newPosition.z - desk.position.z;
                const distSq = dx * dx + dz * dz;
                
                if (distSq < deskCollisionDistance * deskCollisionDistance) {
                    collisionDetected = true;
                    break;
                }
            }
            
            // 2. ë‹¤ë¥¸ ìºë¦­í„°ì™€ì˜ ì¶©ëŒ ê°ì§€
            if (!collisionDetected) {
                const characterCollisionDistance = 1.5;
                for (let otherChar of characters) {
                    if (otherChar === character) continue;
                    
                    const dx = newPosition.x - otherChar.position.x;
                    const dz = newPosition.z - otherChar.position.z;
                    const distSq = dx * dx + dz * dz;
                    
                    if (distSq < characterCollisionDistance * characterCollisionDistance) {
                        collisionDetected = true;
                        break;
                    }
                }
            }
            
            // 3. í”Œë ˆì´ì–´ì™€ì˜ ì¶©ëŒ ê°ì§€
            if (!collisionDetected) {
                const playerCollisionDistance = 1.5;
                const dx = newPosition.x - player.position.x;
                const dz = newPosition.z - player.position.z;
                const distSq = dx * dx + dz * dz;
                
                if (distSq < playerCollisionDistance * playerCollisionDistance) {
                    playerCollision = true;
                    collisionDetected = true;
                }
            }
            
            // 4. ê²½ê³„ì™€ì˜ ì¶©ëŒ ê°ì§€
            if (Math.abs(newPosition.x) > 17 || Math.abs(newPosition.z) > 17) {
                collisionDetected = true;
            }
            
            // ì¶©ëŒ ì²˜ë¦¬
            if (collisionDetected) {
                // ëª¨ë“  ì¶©ëŒ ì‹œ ì¦‰ì‹œ ëœë¤ ê°ë„ë¡œ íšŒì „ (í”Œë ˆì´ì–´ ì¶©ëŒë„ ë™ì¼)
                const rotationAngle = getRandomAngle();
                character.rotation.y += rotationAngle;
            } else {
                // ì¶©ëŒì´ ì—†ìœ¼ë©´ ì´ë™
                character.position.copy(newPosition);
                
                // Walking animation
                const walkBounce = Math.sin(Date.now() * 0.01) * 0.05;
                character.position.y = walkBounce;
                
                // Arm swinging animation
                const armSwing = Math.sin(Date.now() * 0.01) * 0.3;
                character.userData.leftArm.rotation.x = armSwing;
                character.userData.rightArm.rotation.x = -armSwing;
            }
            
            // ê²½ê³„ ë‚´ë¡œ ìœ ì§€
            character.position.x = Math.max(-17, Math.min(17, character.position.x));
            character.position.z = Math.max(-17, Math.min(17, character.position.z));
            
            // íšŒì „ ê³ ì • (X, Zì¶•)
            character.rotation.x = 0;
            character.rotation.z = 0;
        }
        
        // Dialogue system
        let currentCharacter = null;
        let nearbyCharacter = null;
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueName = document.getElementById('dialogue-name');
        const dialogueContent = document.getElementById('dialogue-content');
        const interactionPrompt = document.getElementById('interaction-prompt');
        
        // ëŒ€í™” ë²„íŠ¼ í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸
        interactionPrompt.addEventListener('click', () => {
            if (nearbyCharacter && !currentCharacter) {
                openDialogue(nearbyCharacter);
            }
        });
        
        interactionPrompt.addEventListener('touchstart', (e) => {
            e.preventDefault(); // í„°ì¹˜ ì´ë²¤íŠ¸ê°€ í´ë¦­ìœ¼ë¡œ ì „í™˜ë˜ëŠ” ê²ƒ ë°©ì§€
            if (nearbyCharacter && !currentCharacter) {
                openDialogue(nearbyCharacter);
            }
        });
        
        // ëŒ€í™”ì°½ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        const dialogueCloseBtn = document.getElementById('dialogue-close-btn');
        
        dialogueCloseBtn.addEventListener('click', () => {
            dialogueBox.style.display = 'none';
            currentCharacter = null;
        });
        
        dialogueCloseBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            dialogueBox.style.display = 'none';
            currentCharacter = null;
        });
        
        function getQuizForCharacter(character) {
            const characterName = character.userData.name;
            const quizzes = characterQuizMap[characterName];
            
            if (!quizzes || quizzes.length === 0) {
                return {
                    character: characterName,
                    question: 'ì•„ì§ ì¤€ë¹„ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.',
                    answer: ''
                };
            }
            
            // ëœë¤í•˜ê²Œ í€´ì¦ˆ ì„ íƒ
            const randomIndex = Math.floor(Math.random() * quizzes.length);
            return quizzes[randomIndex];
        }
        
        
        let currentQuiz = null;
        
        function openDialogue(character) {
            // ì´ë¯¸ ì™„ë£Œëœ ìºë¦­í„°ëŠ” ëŒ€í™” ë¶ˆê°€
            if (character.userData.completed) {
                return;
            }
            
            currentCharacter = character;
            
            // ì„ ìƒë‹˜ì¼ ê²½ìš° í•™ìƒ 9ëª… ì™„ë£Œ ì—¬ë¶€ ì²´í¬
            if (character.userData.name === 'ì„ ìƒë‹˜') {
                const allStudentsCompleted = characters
                    .filter(c => c.userData.name !== 'ì„ ìƒë‹˜')
                    .every(c => c.userData.completed);
                
                if (!allStudentsCompleted) {
                    // í•™ìƒ ë¬¸ì œë¥¼ ë‹¤ í’€ì§€ ì•Šì•˜ìœ¼ë©´ ì…ë ¥ í•„ë“œ í‘œì‹œ (ì´ìŠ¤í„° ì—ê·¸ìš©)
                    dialogueBox.style.display = 'block';
                    dialogueName.textContent = character.userData.name;
                    dialogueContent.textContent = 'êµì‹¤ì— ìˆëŠ” 9ëª…ì˜ í•™ìƒë“¤ ë¬¸ì œë¥¼ ëª¨ë‘ í’€ê³  ë‹¤ì‹œ ì˜¤ì„¸ìš”.';
                    
                    // ì…ë ¥ í•„ë“œ í‘œì‹œ (ì´ìŠ¤í„° ì—ê·¸ìš©)
                    document.getElementById('quiz-container').style.display = 'block';
                    const answerInput = document.getElementById('answer-input');
                    const submitButton = document.getElementById('submit-answer');
                    const feedback = document.getElementById('feedback');
                    answerInput.value = '';
                    answerInput.disabled = false;
                    submitButton.disabled = false; // ë²„íŠ¼ í™œì„±í™”
                    answerInput.placeholder = 'ë‹µì„ ì…ë ¥í•˜ì„¸ìš”';
                    feedback.style.display = 'none';
                    
                    // ì„ì‹œ í€´ì¦ˆ ì„¤ì • (ì´ìŠ¤í„° ì—ê·¸ìš©)
                    currentQuiz = {
                        characterName: 'ì„ ìƒë‹˜',
                        question: '',
                        answer: ''
                    };
                    
                    // ì„ ìƒë‹˜ì´ ë’¤ëŒì•„ì„œê¸° (180ë„ íšŒì „)
                    character.userData.stopUntil = Date.now() + 5000;
                    character.rotation.y = Math.PI;
                    
                    setTimeout(() => {
                        answerInput.focus();
                    }, 100);
                    
                    return;
                }
            }
            
            dialogueBox.style.display = 'block';
            
            // ìºë¦­í„°ì— ë§ëŠ” í€´ì¦ˆ ê°€ì ¸ì˜¤ê¸°
            currentQuiz = getQuizForCharacter(character);
            
            // ìºë¦­í„° ì´ë¦„ í‘œì‹œ (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì´ë¦„)
            dialogueName.textContent = currentQuiz.characterName || character.userData.name;
            
            // ì§ˆë¬¸ í‘œì‹œ
            dialogueContent.textContent = currentQuiz.question;
            
            // ì…ë ¥ í•„ë“œ í‘œì‹œ ë° ì´ˆê¸°í™”
            document.getElementById('quiz-container').style.display = 'block';
            const answerInput = document.getElementById('answer-input');
            const submitButton = document.getElementById('submit-answer');
            const feedback = document.getElementById('feedback');
            answerInput.value = '';
            answerInput.disabled = false;
            submitButton.disabled = false; // ë²„íŠ¼ í™œì„±í™”
            answerInput.placeholder = 'ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”';
            feedback.style.display = 'none';
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                answerInput.focus();
            }, 100);
        }
        
        
        
        // ìƒ‰ì¢…ì´ ìƒì„± í•¨ìˆ˜
        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff69b4'];
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // í¬ê¸° ë‹¤ì–‘í™” (5px ~ 20px)
                    const size = 5 + Math.random() * 15;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // ìœ„ì¹˜
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-20px';
                    
                    // ìƒ‰ìƒ
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    
                    // íˆ¬ëª…ë„ (0.6 ~ 1.0) - 3D ëŠë‚Œ
                    confetti.style.opacity = 0.6 + Math.random() * 0.4;
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ (2 ~ 4ì´ˆ)
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                    
                    // z-indexë¡œ ì›ê·¼ê° (9990 ~ 9999)
                    confetti.style.zIndex = Math.floor(9990 + Math.random() * 10);
                    
                    // ì´ˆê¸° íšŒì „ ê°ë„
                    confetti.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 30);
            }
        }
        
        // ëª¨ë“  ë¬¸ì œ í•´ê²° ì‹œ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
        let confettiInterval = null;
        
        function celebrateCompletion() {
            // ì¶•í•˜ ìŒì•… ì¬ìƒ
            playCelebrationMusic();
            
            // ìƒ‰ì¢…ì´ íš¨ê³¼ - ê³„ì† ë–¨ì–´ì§€ë„ë¡
            createConfetti();
            confettiInterval = setInterval(() => {
                createConfetti();
            }, 3000); // 3ì´ˆë§ˆë‹¤ ìƒ‰ì¢…ì´ ë‹¤ì‹œ ìƒì„±
            
            // ì¶•í•˜ ë©”ì‹œì§€ í‘œì‹œ
            const celebrationMessage = document.getElementById('celebration-message');
            celebrationMessage.style.display = 'block';
            
            // ëª¨ë“  ìºë¦­í„°ê°€ ì í”„ (ë§Œì„¸ ë™ì‘ ì—†ì´)
            characters.forEach(character => {
                let jumpCount = 0;
                const jumpInterval = setInterval(() => {
                    if (jumpCount >= 10) {
                        clearInterval(jumpInterval);
                        character.position.y = 0;
                        return;
                    }
                    
                    // ì í”„ ì• ë‹ˆë©”ì´ì…˜
                    const jumpHeight = 0.5;
                    const jumpDuration = 300;
                    const startY = character.position.y;
                    const startTime = Date.now();
                    
                    const animateJump = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = elapsed / jumpDuration;
                        
                        if (progress < 0.5) {
                            character.position.y = startY + jumpHeight * (progress * 2);
                        } else if (progress < 1) {
                            character.position.y = startY + jumpHeight * (2 - progress * 2);
                        } else {
                            character.position.y = startY;
                            jumpCount++;
                            return;
                        }
                        
                        requestAnimationFrame(animateJump);
                    };
                    
                    animateJump();
                }, 400);
            });
            
            // 5ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° (ìƒ‰ì¢…ì´ëŠ” ê³„ì† ë–¨ì–´ì§)
            setTimeout(() => {
                celebrationMessage.style.display = 'none';
            }, 5000);
        }
        
        function checkAnswer() {
            if (!currentQuiz || !currentCharacter) return;
            
            const answerInput = document.getElementById('answer-input');
            const feedback = document.getElementById('feedback');
            const submitButton = document.getElementById('submit-answer');
            
            const userAnswer = answerInput.value.trim();
            
            // ì´ìŠ¤í„° ì—ê·¸ ì²´í¬ (ì„ ìƒë‹˜ê³¼ ëŒ€í™” ì¤‘ì¼ ë•Œ)
            if (currentCharacter.userData.name === 'ì„ ìƒë‹˜' && 
                (userAnswer === 'ì¡°í˜„ì§€' || userAnswer === 'whguswl')) {
                
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                initAudioContext();
                
                // ëª¨ë“  í•™ìƒì„ ì™„ë£Œ ìƒíƒœë¡œ ì„¤ì •
                characters.forEach(character => {
                    if (character.userData.name !== 'ì„ ìƒë‹˜') {
                        character.userData.completed = true;
                        character.userData.returningHome = true;
                        character.userData.targetPosition = character.userData.originalPosition;
                        
                        // ì´ë¦„ ë¼ë²¨ ì œê±°
                        const labelToRemove = character.children.find(child => child.isSprite);
                        if (labelToRemove) {
                            character.remove(labelToRemove);
                        }
                        
                        // ì±…ìƒì— ì´ëª¨ì§€ í‘œì‹œ
                        if (character.userData.deskPosition) {
                            showEmojiOnDesk(
                                character.userData.deskPosition.x,
                                character.userData.deskPosition.z,
                                'ğŸ‰'
                            );
                        }
                    }
                });
                
                // ì„ ìƒë‹˜ë„ ì™„ë£Œ ìƒíƒœë¡œ ì„¤ì •í•˜ê³  ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™
                currentCharacter.userData.completed = true;
                currentCharacter.userData.returningHome = true;
                currentCharacter.userData.targetPosition = currentCharacter.userData.originalPosition;
                
                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateProgressBar();
                
                // ì„ ìƒë‹˜ ì´ë¦„ ë¼ë²¨ ì œê±°
                const teacherLabel = currentCharacter.children.find(child => child.isSprite);
                if (teacherLabel) {
                    currentCharacter.remove(teacherLabel);
                }
                
                // ì›ë˜ ìœ„ì¹˜ë¥¼ ë°”ë¼ë³´ë„ë¡ íšŒì „
                const originalPos = currentCharacter.userData.originalPosition;
                const dx = originalPos.x - currentCharacter.position.x;
                const dz = originalPos.z - currentCharacter.position.z;
                const angle = Math.atan2(dx, dz);
                currentCharacter.rotation.y = angle;
                
                feedback.style.display = 'block';
                feedback.style.background = '#ffd700';
                feedback.style.color = '#333';
                feedback.textContent = 'ğŸŒŸ ì´ìŠ¤í„° ì—ê·¸ ë°œê²¬! ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!';
                
                playCorrectSound();
                
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                    currentCharacter = null;
                    
                    // ì ì‹œ í›„ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
                    setTimeout(() => {
                        celebrateCompletion();
                    }, 2000);
                }, 2000);
                
                return;
            }
            
            const correctAnswer = currentQuiz.answer.trim();
            
            if (userAnswer === '') {
                feedback.style.display = 'block';
                feedback.style.background = '#fff3cd';
                feedback.style.color = '#856404';
                feedback.textContent = 'ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                return;
            }
            
            // ì •ë‹µ ë¹„êµ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ê³µë°± ì œê±°)
            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            
            answerInput.disabled = true;
            submitButton.disabled = true;
            
            if (isCorrect) {
                // ì´ë¯¸ 10ëª…ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì•ˆì „ì¥ì¹˜)
                const completedCount = characters.filter(c => c.userData.completed).length;
                if (completedCount >= 10) {
                    feedback.style.display = 'block';
                    feedback.style.background = '#fff3cd';
                    feedback.style.color = '#856404';
                    feedback.textContent = 'ì´ë¯¸ ëª¨ë“  ë¬¸ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                    
                    setTimeout(() => {
                        dialogueBox.style.display = 'none';
                        currentCharacter = null;
                    }, 2000);
                    return;
                }
                
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ì •ë‹µ íš¨ê³¼ìŒ
                initAudioContext();
                playCorrectSound();
                
                feedback.style.display = 'block';
                feedback.style.background = '#d4edda';
                feedback.style.color = '#155724';
                feedback.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!';
                
                // ìºë¦­í„° ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
                currentCharacter.userData.completed = true;
                currentCharacter.userData.returningHome = true; // ì§‘ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ì¤‘
                currentCharacter.userData.targetPosition = currentCharacter.userData.originalPosition;
                
                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateProgressBar();
                
                // ì›ë˜ ìœ„ì¹˜ë¥¼ ë°”ë¼ë³´ë„ë¡ íšŒì „
                const originalPos = currentCharacter.userData.originalPosition;
                const dx = originalPos.x - currentCharacter.position.x;
                const dz = originalPos.z - currentCharacter.position.z;
                const angle = Math.atan2(dx, dz);
                currentCharacter.rotation.y = angle;
                
                // ì´ë¦„ ë¼ë²¨ ì œê±° (childrenì—ì„œ Sprite ì°¾ì•„ì„œ ì œê±°)
                const labelToRemove = currentCharacter.children.find(child => child.isSprite);
                if (labelToRemove) {
                    currentCharacter.remove(labelToRemove);
                }
                
                // ì±…ìƒ ëª¨ë‹ˆí„°ì— ì´ëª¨ì§€ í‘œì‹œ (í•™ìƒë§Œ)
                if (currentCharacter.userData.deskPosition) {
                    showEmojiOnDesk(
                        currentCharacter.userData.deskPosition.x,
                        currentCharacter.userData.deskPosition.z,
                        'ğŸ‰'
                    );
                }
                
                // ì„ ìƒë‹˜ ë¬¸ì œë¥¼ í’€ì—ˆëŠ”ì§€ í™•ì¸
                const isTeacher = currentCharacter.userData.name === 'ì„ ìƒë‹˜';
                
                // 2ì´ˆ í›„ ëŒ€í™”ì°½ ë‹«ê¸°
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                    currentCharacter = null;
                    
                    // ì„ ìƒë‹˜ ë¬¸ì œë¥¼ í’€ì—ˆì„ ë•Œë§Œ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
                    if (isTeacher) {
                        setTimeout(() => {
                            celebrateCompletion();
                        }, 2000);
                    }
                }, 2000);
            } else {
                // ì˜¤ë‹µ íš¨ê³¼ìŒ
                initAudioContext();
                playWrongSound();
                
                feedback.style.display = 'block';
                feedback.style.background = '#f8d7da';
                feedback.style.color = '#721c24';
                feedback.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤!';
                
                // 2ì´ˆ í›„ ìƒˆ ë¬¸ì œ (ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”)
                setTimeout(() => {
                    submitButton.disabled = false;
                    openDialogue(currentCharacter);
                }, 2000);
            }
        }
        
        // Set up custom question handlers
        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        let answerInputElement = null;
        let submitButtonElement = null;
        
        function setupEventListeners() {
            answerInputElement = document.getElementById('answer-input');
            submitButtonElement = document.getElementById('submit-answer');
            
            if (submitButtonElement && answerInputElement) {
                // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¬ë“±ë¡
                submitButtonElement.removeEventListener('click', checkAnswer);
                submitButtonElement.addEventListener('click', checkAnswer);
                
                answerInputElement.removeEventListener('keypress', handleEnterKey);
                answerInputElement.addEventListener('keypress', handleEnterKey);
            }
        }
        
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer();
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰
        setupEventListeners();
        
        // Animation loop
        let lastTime = 0;
        
        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // Update player movement
            player.velocity.set(0, 0, 0);
            
            // ëŒ€í™” ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì´ë™ ê°€ëŠ¥
            if (!currentCharacter) {
                // ë°©í–¥í‚¤ë¡œ ì´ë™
                if (keys['ArrowUp']) player.velocity.z = player.speed;
                if (keys['ArrowDown']) player.velocity.z = -player.speed;
                if (keys['ArrowLeft']) player.velocity.x = -player.speed;
                if (keys['ArrowRight']) player.velocity.x = player.speed;
            }
            
            // Update camera rotation based on mouse (ì¢Œìš°ë§Œ)
            camera.rotation.y = mouseX;
            camera.rotation.x = 0; // ìƒí•˜ íšŒì „ ê³ ì •
            
            // Apply movement in camera direction
            const forward = new THREE.Vector3(0, 0, -1);
            forward.applyQuaternion(camera.quaternion);
            forward.y = 0;
            forward.normalize();
            
            const right = new THREE.Vector3(1, 0, 0);
            right.applyQuaternion(camera.quaternion);
            right.y = 0;
            right.normalize();
            
            // ìƒˆë¡œìš´ í”Œë ˆì´ì–´ ìœ„ì¹˜ ê³„ì‚°
            const newPlayerPosition = player.position.clone();
            newPlayerPosition.add(forward.multiplyScalar(player.velocity.z));
            newPlayerPosition.add(right.multiplyScalar(player.velocity.x));
            
            // í”Œë ˆì´ì–´ê°€ ì›€ì§ì˜€ëŠ”ì§€ í™•ì¸ (velocityê°€ 0ì´ ì•„ë‹ˆë©´)
            if (!charactersCanMove && (player.velocity.x !== 0 || player.velocity.z !== 0)) {
                charactersCanMove = true;
            }
            
            // ì¶©ëŒ ê°ì§€
            let playerCollision = false;
            
            // 1. ì±…ìƒê³¼ì˜ ì¶©ëŒ ê°ì§€
            const deskCollisionDistance = 1.8;
            for (let desk of desks) {
                const dx = newPlayerPosition.x - desk.position.x;
                const dz = newPlayerPosition.z - desk.position.z;
                const distSq = dx * dx + dz * dz; // ì œê³±ê·¼ ìƒëµ (ìµœì í™”)
                
                if (distSq < deskCollisionDistance * deskCollisionDistance) {
                    playerCollision = true;
                    break;
                }
            }
            
            // 2. ìºë¦­í„°ì™€ì˜ ì¶©ëŒ ê°ì§€
            if (!playerCollision) {
                const characterCollisionDistance = 1.5;
                for (let character of characters) {
                    const dx = newPlayerPosition.x - character.position.x;
                    const dz = newPlayerPosition.z - character.position.z;
                    const distSq = dx * dx + dz * dz;
                    
                    if (distSq < characterCollisionDistance * characterCollisionDistance) {
                        playerCollision = true;
                        break;
                    }
                }
            }
            
            // ì¶©ëŒì´ ì—†ìœ¼ë©´ ì´ë™
            if (!playerCollision) {
                player.position.copy(newPlayerPosition);
            }
            
            // Keep player in bounds
            player.position.x = Math.max(-18, Math.min(18, player.position.x));
            player.position.z = Math.max(-18, Math.min(18, player.position.z));
            
            // Update camera position
            camera.position.copy(player.position);
            camera.rotation.z = 0;
            camera.rotation.y = mouseX;
            camera.rotation.x = 0; // ìƒí•˜ íšŒì „ ê³ ì •
            
            // Update character movement (ëŒ€í™” ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
            if (!currentCharacter) {
                characters.forEach(character => {
                    updateCharacterMovement(character, deltaTime);
                });
            }
            
            // Check for nearby characters (ìˆ˜í‰ ê±°ë¦¬ë§Œ ê³„ì‚°)
            nearbyCharacter = null;
            let minDistance = Infinity;
            
            characters.forEach(character => {
                // yì¶•ì„ ë¬´ì‹œí•˜ê³  x, z í‰ë©´ì—ì„œì˜ ê±°ë¦¬ë§Œ ê³„ì‚°
                const dx = player.position.x - character.position.x;
                const dz = player.position.z - character.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                
                if (distance < 2 && distance < minDistance) {
                    minDistance = distance;
                    nearbyCharacter = character;
                }
            });
            
            // Auto-close dialogue if player walks away (ëŒ€í™” ì¤‘ì—ëŠ” í”Œë ˆì´ì–´ê°€ ì›€ì§ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”)
            // ëŒ€í™”ì°½ì€ X ë²„íŠ¼ìœ¼ë¡œë§Œ ë‹«í˜
            
            // Show/hide interaction prompt
            if (nearbyCharacter && !currentCharacter && !nearbyCharacter.userData.completed) {
                interactionPrompt.style.display = 'flex';
                interactionPrompt.textContent = 'ëŒ€í™”í•˜ê¸°';
                
                // ì´ë¯¸ ì •ì§€ ì¤‘ì¸ ë‹¤ë¥¸ ìºë¦­í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                const alreadyStoppedCharacter = characters.find(char => 
                    char.userData.stopUntil && Date.now() < char.userData.stopUntil
                );
                
                // ì´ë¯¸ ì •ì§€ ì¤‘ì¸ ìºë¦­í„°ê°€ ì—†ê±°ë‚˜, ê·¼ì²˜ ìºë¦­í„°ê°€ ë°”ë¡œ ê·¸ ìºë¦­í„°ì¸ ê²½ìš°ì—ë§Œ ì„¤ì •
                if (!alreadyStoppedCharacter || alreadyStoppedCharacter === nearbyCharacter) {
                    // stopUntilì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¯¸ ë§Œë£Œëœ ê²½ìš°ì—ë§Œ ìƒˆë¡œ ì„¤ì •
                    if (!nearbyCharacter.userData.stopUntil || Date.now() >= nearbyCharacter.userData.stopUntil) {
                        // ìºë¦­í„°ê°€ í”Œë ˆì´ì–´ë¥¼ ë°”ë¼ë³´ê²Œ ì„¤ì •
                        const lookTarget = new THREE.Vector3(player.position.x, nearbyCharacter.position.y, player.position.z);
                        nearbyCharacter.lookAt(lookTarget);
                        nearbyCharacter.rotation.x = 0;
                        nearbyCharacter.rotation.z = 0;
                        
                        // 2ì´ˆê°„ ì •ì§€ ì„¤ì •
                        nearbyCharacter.userData.stopUntil = Date.now() + 2000;
                    }
                }
            } else {
                interactionPrompt.style.display = 'none';
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Mouse look
        let mouseX = 0;
        let mouseY = 0;
        
        // Mouse drag for camera rotation
        let isDragging = false;
        let previousMouseX = 0;
        
        renderer.domElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMouseX = e.clientX;
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - previousMouseX;
                mouseX -= deltaX * 0.005; // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ë¡œ ì‹œì  íšŒì „
                previousMouseX = e.clientX;
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // Touch swipe for camera rotation (ìŠ¤ë§ˆíŠ¸íŒ¨ë“œ/ëª¨ë°”ì¼)
        let touchStartX = 0;
        let isTouching = false;
        
        // ìº”ë²„ìŠ¤ í„°ì¹˜ ì´ë²¤íŠ¸ (ë°©í–¥í‚¤ì™€ ë…ë¦½ì ìœ¼ë¡œ ì‘ë™)
        let canvasTouchId = null; // ìº”ë²„ìŠ¤ í„°ì¹˜ì˜ ì‹ë³„ì
        
        renderer.domElement.addEventListener('touchstart', (e) => {
            // ìº”ë²„ìŠ¤ì—ì„œ ì‹œì‘ëœ ì²« ë²ˆì§¸ í„°ì¹˜ë§Œ ì‹œì  ì´ë™ì— ì‚¬ìš©
            if (canvasTouchId === null && e.touches.length > 0) {
                // ìº”ë²„ìŠ¤ë¥¼ í„°ì¹˜í•œ ê²ƒ ì¤‘ ì²« ë²ˆì§¸ ì°¾ê¸°
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    if (touch.target === renderer.domElement) {
                        canvasTouchId = touch.identifier;
                        touchStartX = touch.clientX;
                        isTouching = true;
                        break;
                    }
                }
                e.preventDefault();
            }
        });
        
        renderer.domElement.addEventListener('touchmove', (e) => {
            // ì €ì¥ëœ í„°ì¹˜ IDì™€ ì¼ì¹˜í•˜ëŠ” í„°ì¹˜ë§Œ ì²˜ë¦¬
            if (canvasTouchId !== null) {
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    if (touch.identifier === canvasTouchId) {
                        const deltaX = touch.clientX - touchStartX;
                        mouseX -= deltaX * 0.005; // í„°ì¹˜ ìŠ¤ì™€ì´í”„ë¡œ ì‹œì  íšŒì „
                        touchStartX = touch.clientX;
                        e.preventDefault();
                        break;
                    }
                }
            }
        });
        
        renderer.domElement.addEventListener('touchend', (e) => {
            // í•´ë‹¹ í„°ì¹˜ê°€ ëë‚¬ëŠ”ì§€ í™•ì¸
            if (canvasTouchId !== null) {
                let touchStillActive = false;
                for (let i = 0; i < e.touches.length; i++) {
                    if (e.touches[i].identifier === canvasTouchId) {
                        touchStillActive = true;
                        break;
                    }
                }
                
                if (!touchStillActive) {
                    canvasTouchId = null;
                    isTouching = false;
                }
            }
        });
        
        renderer.domElement.addEventListener('touchcancel', () => {
            // í„°ì¹˜ê°€ ì·¨ì†Œë˜ë©´ ì¦‰ì‹œ ì´ˆê¸°í™”
            canvasTouchId = null;
            isTouching = false;
        });
        
        
        // ì•± ì‹œì‘ - ë¨¼ì € ë°ì´í„° ë¡œë“œ
        loadQuizData().then(success => {
            if (success) {
                updateProgressBar(); // ì´ˆê¸° ì§„í–‰ ìƒíƒœ í‘œì‹œ
                animate(0);
            } else {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ë¡œ ì•±ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
    </script>
</body>
</html>