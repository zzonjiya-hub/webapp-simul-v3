<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÍµêÏã§ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ v3 - Google Sheets Ïó∞Îèô</title>
    <!-- Noto Sans KR Ìè∞Ìä∏ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            background: #000;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        #dialogue-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            z-index: 1000;
        }
        
        #dialogue-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            transition: all 0.3s ease;
            font-weight: bold;
            line-height: 1;
        }
        
        #dialogue-close-btn:hover {
            background: rgba(217, 115, 86, 0.2);
            color: #D97356;
            transform: scale(1.1);
        }
        
        #dialogue-close-btn:active {
            transform: scale(0.95);
        }
        
        #dialogue-box h3 {
            margin: 0 0 10px 0;
            color: #D97356;
        }
        
        #dialogue-content {
            margin: 10px 0;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dialogue-option {
            background: #f0f0f0;
            border: 2px solid #D97356;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dialogue-option:hover {
            background: #D97356;
            color: white;
            transform: translateX(5px);
        }
        
        #custom-question-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        #custom-question-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #D97356;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        #custom-question-submit {
            background: #D97356;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #custom-question-submit:hover {
            background: #c85a3f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        #custom-question-submit:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(217, 115, 86, 0.3);
            border-radius: 50%;
            border-top-color: #D97356;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instruction {
            opacity: 0.8;
            font-size: 14px;
            margin-top: 10px;
        }
        
        #interaction-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: none;
            font-size: 36px;
            font-weight: bold;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        #interaction-prompt:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
            border-color: rgba(255, 255, 255, 1);
        }
        
        #interaction-prompt:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        
        .floating-text {
            position: absolute;
            color: #ff0;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }
        
        /* ÏÉâÏ¢ÖÏù¥ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
            z-index: 9999;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotateX(0deg) rotateY(0deg) rotateZ(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateX(720deg) rotateY(720deg) rotateZ(720deg);
                opacity: 0;
            }
        }
        
        /* Ï∂ïÌïò Î©îÏãúÏßÄ */
        #celebration-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 215, 0, 0.95);
            color: #333;
            padding: 40px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            animation: celebration-appear 0.5s ease-out forwards;
        }
        
        @keyframes celebration-appear {
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº (ÏôºÏ™Ω ÏïÑÎûò) */
        #navigation-controls {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(2, 100px);
            gap: 12px;
        }
        
        .nav-button {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        .nav-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº (ÏôºÏ™Ω ÏúÑ) */
        #screenshot-button {
            position: fixed;
            top: 30px;
            left: 30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            padding: 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        #screenshot-button svg {
            width: 50px;
            height: 50px;
            fill: none;
            stroke: white;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        #screenshot-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        #screenshot-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* Ï†ÑÏ≤¥ÌôîÎ©¥ Î≤ÑÌäº (Ïò§Î•∏Ï™Ω ÏúÑ) */
        #fullscreen-button {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        #fullscreen-button svg {
            width: 45px;
            height: 45px;
            fill: none;
            stroke: white;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        #fullscreen-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }
        
        #fullscreen-button:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0.95);
        }
        
        /* ÏßÑÌñâ ÏÉÅÌÉúÎ∞î (Ïò§Î•∏Ï™Ω ÏïÑÎûò) */
        #progress-bar {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 50px;
            font-weight: bold;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', sans-serif;
            letter-spacing: -2px;
            line-height: 1;
            padding-bottom: 3px;
        }
        
        /* UI Ïà®Í∏∞Í∏∞ ÌÅ¥ÎûòÏä§ */
        .hide-ui {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <!-- UI Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞Îê® -->
    
    <!-- Î°úÎî© ÌôîÎ©¥ -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;">
        <div style="font-size: 24px; margin-bottom: 20px;">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
        <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
            <div id="loading-bar" style="width: 0%; height: 100%; background: #D97356; transition: width 0.3s;"></div>
        </div>
        <div id="loading-status" style="margin-top: 10px; font-size: 14px; opacity: 0.8;">Google Sheets Ïó∞Í≤∞ Ï§ë...</div>
    </div>
    
    <div id="dialogue-box">
        <button id="dialogue-close-btn">√ó</button>
        <h3 id="dialogue-name">Ïù¥Î¶Ñ</h3>
        <div id="dialogue-content" style="font-size: 18px; font-weight: bold; margin-bottom: 20px;">ÏßàÎ¨∏Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</div>
        <div id="quiz-container">
            <input type="text" id="answer-input" placeholder="Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width: 100%; padding: 12px; border: 2px solid #D97356; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px;">
            <button id="submit-answer" style="width: 100%; background: #D97356; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; transition: all 0.3s;">Ï†ïÎãµ Ï†úÏ∂ú</button>
            <div id="feedback" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none; font-weight: bold; text-align: center;"></div>
        </div>
    </div>
    
    <div id="interaction-prompt">ÎåÄÌôîÌïòÍ∏∞</div>
    
    <!-- Ï∂ïÌïò Î©îÏãúÏßÄ -->
    <div id="celebration-message">
        üéâ Ï∂ïÌïòÌï©ÎãàÎã§! üéâ<br>
        Î™®Îì† Î¨∏Ï†úÎ•º Ìï¥Í≤∞ÌñàÏäµÎãàÎã§!
    </div>
    
    <!-- Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº (ÏôºÏ™Ω ÏúÑ) -->
    <button id="screenshot-button" title="ÌôîÎ©¥ Ï∫°Ï≤ò">
        <svg viewBox="0 0 24 24">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
            <circle cx="12" cy="13" r="4"></circle>
        </svg>
    </button>
    
    <!-- Ï†ÑÏ≤¥ÌôîÎ©¥ Î≤ÑÌäº (Ïò§Î•∏Ï™Ω ÏúÑ) -->
    <button id="fullscreen-button" title="Ï†ÑÏ≤¥ÌôîÎ©¥">
        <svg viewBox="0 0 24 24">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
    </button>
    
    <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº (ÏôºÏ™Ω ÏïÑÎûò) -->
    <div id="navigation-controls">
        <div></div>
        <button class="nav-button" id="nav-up">‚ñ≤</button>
        <div></div>
        <button class="nav-button" id="nav-left">‚óÄ</button>
        <button class="nav-button" id="nav-down">‚ñº</button>
        <button class="nav-button" id="nav-right">‚ñ∂</button>
    </div>
    
    <!-- ÏßÑÌñâ ÏÉÅÌÉúÎ∞î (Ïò§Î•∏Ï™Ω ÏïÑÎûò) -->
    <div id="progress-bar">0</div>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Ìö®Í≥ºÏùå ÏÉùÏÑ± Ìï®Ïàò
        let audioContext = null;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }
        
        function playCorrectSound() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 523.25; // C5
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.5);
            
            // ÌôîÏùå Ï∂îÍ∞Ä
            setTimeout(() => {
                const oscillator2 = ctx.createOscillator();
                const gainNode2 = ctx.createGain();
                
                oscillator2.connect(gainNode2);
                gainNode2.connect(ctx.destination);
                
                oscillator2.frequency.value = 659.25; // E5
                oscillator2.type = 'sine';
                
                gainNode2.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                oscillator2.start(ctx.currentTime);
                oscillator2.stop(ctx.currentTime + 0.5);
            }, 100);
        }
        
        function playWrongSound() {
            const ctx = initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 200; // ÎÇÆÏùÄ Ïùå
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.3);
        }
        
        function playCelebrationMusic() {
            const ctx = initAudioContext();
            const notes = [523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, 1046.50]; // C major scale
            let noteIndex = 0;
            
            const playNote = () => {
                if (noteIndex >= notes.length * 4) return; // 4Î≤à Î∞òÎ≥µ
                
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.frequency.value = notes[noteIndex % notes.length];
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.2);
                
                noteIndex++;
                setTimeout(playNote, 150);
            };
            
            playNote();
        }
        
        // Google Sheets Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î≥ÄÏàò
        let quizData = [];
        let characterQuizMap = {};
        let boardInfo = {}; // Ïπ†Ìåê Ï†ïÎ≥¥
        
        // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ (Google Sheets Î°úÎî© Ïã§Ìå® Ïãú ÏÇ¨Ïö©)
        const defaultData = {
            "Ïπ†Ìåê 1Ï§Ñ": "ÎçßÏÖà",
            "Ïπ†Ìåê 2Ï§Ñ": "Í∞ôÏùÄ ÏàòÏùò ÎçßÏÖàÏùÑ Í≥ÑÏÇ∞Ìï¥Î≥¥Ïûê.",
            "Ïπ†Ìåê 3Ï§Ñ": "ÌôúÎèô1 - ÌïôÏÉù 9Î™ÖÏùò Î¨∏Ï†úÎ•º Î™®Îëê Ìï¥Í≤∞ÌïòÍ∏∞",
            "Ïπ†Ìåê 4Ï§Ñ": "ÌôúÎèô2 - ÏÑ†ÏÉùÎãò Î¨∏Ï†úÎ•º Ìï¥Í≤∞ÌïòÍ≥† 10Ï†ê ÎßåÎì§Í∏∞",
            "Ïπ†Ìåê 5Ï§Ñ": "ÌôúÎèô3 - Ïπ†ÌåêÏùò ÎÇ¥Ïö©Ïù¥ Î≥¥Ïù¥ÎèÑÎ°ù ÏÇ¨ÏßÑ Ï∞çÍ∏∞",
            "ÏÑ†ÏÉùÎãò Ïù¥Î¶Ñ": "Ï°∞Í∏∞ÏÑù ÏÑ†ÏÉùÎãò",
            "ÌïôÏÉù1 Ïù¥Î¶Ñ": "ÌïôÏÉù1",
            "ÌïôÏÉù2 Ïù¥Î¶Ñ": "ÌïôÏÉù2",
            "ÌïôÏÉù3 Ïù¥Î¶Ñ": "ÌïôÏÉù3",
            "ÌïôÏÉù4 Ïù¥Î¶Ñ": "ÌïôÏÉù4",
            "ÌïôÏÉù5 Ïù¥Î¶Ñ": "ÌïôÏÉù5",
            "ÌïôÏÉù6 Ïù¥Î¶Ñ": "ÌïôÏÉù6",
            "ÌïôÏÉù7 Ïù¥Î¶Ñ": "ÌïôÏÉù7",
            "ÌïôÏÉù8 Ïù¥Î¶Ñ": "ÌïôÏÉù8",
            "ÌïôÏÉù9 Ïù¥Î¶Ñ": "ÌïôÏÉù9",
            "ÏÑ†ÏÉùÎãò Î¨∏Ï†ú": "10+10=?",
            "ÏÑ†ÏÉùÎãò Ï†ïÎãµ": "20",
            "ÌïôÏÉù1 Î¨∏Ï†ú": "1+1=?",
            "ÌïôÏÉù1 Ï†ïÎãµ": "2",
            "ÌïôÏÉù2 Î¨∏Ï†ú": "2+2=?",
            "ÌïôÏÉù2 Ï†ïÎãµ": "4",
            "ÌïôÏÉù3 Î¨∏Ï†ú": "3+3=?",
            "ÌïôÏÉù3 Ï†ïÎãµ": "6",
            "ÌïôÏÉù4 Î¨∏Ï†ú": "4+4=?",
            "ÌïôÏÉù4 Ï†ïÎãµ": "8",
            "ÌïôÏÉù5 Î¨∏Ï†ú": "5+5=?",
            "ÌïôÏÉù5 Ï†ïÎãµ": "10",
            "ÌïôÏÉù6 Î¨∏Ï†ú": "6+6=?",
            "ÌïôÏÉù6 Ï†ïÎãµ": "12",
            "ÌïôÏÉù7 Î¨∏Ï†ú": "7+7=?",
            "ÌïôÏÉù7 Ï†ïÎãµ": "14",
            "ÌïôÏÉù8 Î¨∏Ï†ú": "8+8=?",
            "ÌïôÏÉù8 Ï†ïÎãµ": "16",
            "ÌïôÏÉù9 Î¨∏Ï†ú": "9+9=?",
            "ÌïôÏÉù9 Ï†ïÎãµ": "18"
        };
        
        // Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ìï®Ïàò (Google SheetsÏôÄ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Í≥µÌÜµ ÏÇ¨Ïö©)
        function parseData(dataMap) {
            // Ïπ†Ìåê Ï†ïÎ≥¥ Ï∂îÏ∂ú (Ïπ†Ìåê 1-5Ï§Ñ)
            boardInfo = {
                line1: dataMap['Ïπ†Ìåê 1Ï§Ñ'] || dataMap['ÏßàÎ¨∏ 1Ï§Ñ'] || 'Ïπ†Ìåê 1Ï§Ñ',
                line2: dataMap['Ïπ†Ìåê 2Ï§Ñ'] || dataMap['ÏßàÎ¨∏ 2Ï§Ñ'] || 'Ïπ†Ìåê 2Ï§Ñ',
                line3: dataMap['Ïπ†Ìåê 3Ï§Ñ'] || dataMap['ÏßàÎ¨∏ 3Ï§Ñ'] || 'Ïπ†Ìåê 3Ï§Ñ',
                line4: dataMap['Ïπ†Ìåê 4Ï§Ñ'] || dataMap['ÏßàÎ¨∏ 4Ï§Ñ'] || 'Ïπ†Ìåê 4Ï§Ñ',
                line5: dataMap['Ïπ†Ìåê 5Ï§Ñ'] || dataMap['ÏßàÎ¨∏ 5Ï§Ñ'] || 'Ïπ†Ìåê 5Ï§Ñ'
            };
            
            // Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ Ï∂îÏ∂ú
            const characterNames = {
                'ÏÑ†ÏÉùÎãò': dataMap['ÏÑ†ÏÉùÎãò Ïù¥Î¶Ñ'] || 'ÏÑ†ÏÉùÎãò',
                'ÌïôÏÉù1': dataMap['ÌïôÏÉù1 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù1',
                'ÌïôÏÉù2': dataMap['ÌïôÏÉù2 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù2',
                'ÌïôÏÉù3': dataMap['ÌïôÏÉù3 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù3',
                'ÌïôÏÉù4': dataMap['ÌïôÏÉù4 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù4',
                'ÌïôÏÉù5': dataMap['ÌïôÏÉù5 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù5',
                'ÌïôÏÉù6': dataMap['ÌïôÏÉù6 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù6',
                'ÌïôÏÉù7': dataMap['ÌïôÏÉù7 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù7',
                'ÌïôÏÉù8': dataMap['ÌïôÏÉù8 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù8',
                'ÌïôÏÉù9': dataMap['ÌïôÏÉù9 Ïù¥Î¶Ñ'] || 'ÌïôÏÉù9'
            };
            
            // ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            quizData = [];
            characterQuizMap = {};
            
            // Î¨∏Ï†ú/Ï†ïÎãµ Ï∂îÏ∂ú
            for (const [key, name] of Object.entries(characterNames)) {
                const question = dataMap[`${key} Î¨∏Ï†ú`];
                const answer = dataMap[`${key} Ï†ïÎãµ`];
                
                if (question && answer) {
                    const quiz = {
                        character: key,  // "ÏÑ†ÏÉùÎãò", "ÌïôÏÉù1" Îì±
                        characterName: name,  // "Ï°∞Í∏∞ÏÑù ÏÑ†ÏÉùÎãò", "ÌïôÏÉù1" Îì±
                        question: question,
                        answer: String(answer).replace('.0', '') // .0 Ï†úÍ±∞
                    };
                    
                    quizData.push(quiz);
                    
                    // ÌÇ§("ÏÑ†ÏÉùÎãò", "ÌïôÏÉù1" Îì±)Î°ú Ï†ÄÏû•
                    if (!characterQuizMap[key]) {
                        characterQuizMap[key] = [];
                    }
                    characterQuizMap[key].push(quiz);
                }
            }
        }
        
        // Google SheetsÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function loadQuizData() {
            const sheetId = '1GH3AT-sn_7S0bkvYNPgm-kdR7cX3-gkyd1p7zwvxOfc';
            const gid = '0'; // Ï≤´Î≤àÏß∏ ÏãúÌä∏
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
            
            const loadingBar = document.getElementById('loading-bar');
            const loadingStatus = document.getElementById('loading-status');
            
            try {
                loadingBar.style.width = '30%';
                loadingStatus.textContent = 'Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú Ï§ë...';
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                loadingBar.style.width = '60%';
                loadingStatus.textContent = 'Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ï§ë...';
                
                // CSV ÌååÏã±
                const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
                
                console.log('Ï†ÑÏ≤¥ ÎùºÏù∏ Ïàò:', lines.length);
                console.log('Ï≤´ 10Ï§Ñ:', lines.slice(0, 10));
                
                // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌååÏã±
                const dataMap = {};
                
                for (let i = 0; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 2) {
                        const key = values[0].replace(/"/g, '').trim();
                        const value = values[1].replace(/"/g, '').trim();
                        dataMap[key] = value;
                    }
                }
                
                console.log('ÌååÏã±Îêú Îç∞Ïù¥ÌÑ∞:', dataMap);
                
                // parseData Ìï®ÏàòÎ°ú Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                parseData(dataMap);
                
                loadingBar.style.width = '100%';
                loadingStatus.textContent = 'Google Sheets Î°úÎî© ÏôÑÎ£å!';
                
                console.log('ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', quizData.length, 'Í∞ú');
                console.log('Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Îç∞Ïù¥ÌÑ∞:', characterQuizMap);
                console.log('Ïπ†Ìåê Ï†ïÎ≥¥:', boardInfo);
                
                // Ïπ†Ìåê ÏóÖÎç∞Ïù¥Ìä∏
                updateBlackboard(boardInfo);
                
                // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
                
                return true;
            } catch (error) {
                console.error('Google Sheets Î°úÎìú Ïã§Ìå®:', error);
                console.log('Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú Ï†ÑÌôòÌï©ÎãàÎã§...');
                
                loadingBar.style.width = '60%';
                loadingStatus.innerHTML = `Google Sheets Î°úÎìú Ïã§Ìå®<br><small>Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ¨Ïö©Ìï©ÎãàÎã§</small>`;
                loadingStatus.style.color = '#ffa500';
                
                // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                parseData(defaultData);
                
                loadingBar.style.width = '100%';
                loadingBar.style.background = '#ffa500';
                loadingStatus.textContent = 'Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å!';
                
                console.log('Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', quizData.length, 'Í∞ú');
                console.log('Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Îç∞Ïù¥ÌÑ∞:', characterQuizMap);
                console.log('Ïπ†Ìåê Ï†ïÎ≥¥:', boardInfo);
                
                // Ïπ†Ìåê ÏóÖÎç∞Ïù¥Ìä∏
                updateBlackboard(boardInfo);
                
                // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 1000);
                
                return true;
            }
        }
        
        // CSV ÎùºÏù∏ ÌååÏã± Ìï®Ïàò (Îî∞Ïò¥Ìëú Ï≤òÎ¶¨)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Î∞ùÏùÄ ÌïòÎäòÏÉâ
        scene.fog = new THREE.Fog(0xf5f5f5, 10, 50); // ÏõêÎûò ÏïàÍ∞ú ÏÉâÏÉÅ
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.25, 5);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            preserveDrawingBuffer: true  // Ïä§ÌÅ¨Î¶∞ÏÉ∑ÏùÑ ÏúÑÌï¥ ÌïÑÏöî
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(10, 15, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.camera.near = 0.1;
        directionalLight.shadow.camera.far = 50;
        directionalLight.shadow.camera.left = -30;
        directionalLight.shadow.camera.right = 30;
        directionalLight.shadow.camera.top = 30;
        directionalLight.shadow.camera.bottom = -30;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        directionalLight.shadow.radius = 3; // Í∑∏Î¶ºÏûê Î∏îÎü¨ Ï†ÅÏö©
        scene.add(directionalLight);
        
        // Floor with pattern
        const floorGeometry = new THREE.PlaneGeometry(40, 40);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xdcdcdc,
            roughness: 0.7,
            metalness: 0.1
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        
        // Add floor tiles pattern
        const tileGeometry = new THREE.PlaneGeometry(2, 2);
        const tileMaterial1 = new THREE.MeshStandardMaterial({ color: 0xc19a6b }); // Î∞ùÏùÄ Í∞àÏÉâ
        const tileMaterial2 = new THREE.MeshStandardMaterial({ color: 0xd2b48c }); // Ïó∞Ìïú Í∞àÏÉâ
        
        for (let x = -20; x < 20; x += 2) {
            for (let z = -20; z < 20; z += 2) {
                const tile = new THREE.Mesh(tileGeometry, ((x + z) / 2) % 2 === 0 ? tileMaterial1 : tileMaterial2);
                tile.position.set(x + 1, 0.01, z + 1);
                tile.rotation.x = -Math.PI / 2;
                tile.receiveShadow = true;
                scene.add(tile);
            }
        }
        
        // Walls with windows
        const wallMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xfafafa, // Îçî Î∞ùÏùÄ ÌöåÏÉâ
            roughness: 0.9
        });
        
        const wallThickness = 0.3; // Î≤Ω ÎëêÍªò
        
        // Back wall (no windows)
        const backWall = new THREE.Mesh(
            new THREE.BoxGeometry(40, 5, wallThickness),
            wallMaterial
        );
        backWall.position.set(0, 2.5, -20);
        backWall.receiveShadow = true;
        backWall.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(backWall);
        
        // Front wall (no windows)
        const frontWall = new THREE.Mesh(
            new THREE.BoxGeometry(40, 5, wallThickness),
            wallMaterial
        );
        frontWall.position.set(0, 2.5, 20);
        frontWall.receiveShadow = true;
        frontWall.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(frontWall);
        
        // Left wall with window holes (ÏÑúÏ™Ω Î≤Ω)
        // ÏúÑÏ™Ω Î≤Ω (Ï≤úÏû• ÏïÑÎûò)
        const leftWallTop = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        leftWallTop.position.set(-20, 4.5, 0);
        leftWallTop.receiveShadow = true;
        leftWallTop.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(leftWallTop);
        
        // ÏïÑÎûòÏ™Ω Î≤Ω (Î∞îÎã•Î∂ÄÌÑ∞ ÏãúÏûë)
        const leftWallBottom = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        leftWallBottom.position.set(-20, 0.5, 0);
        leftWallBottom.receiveShadow = true;
        leftWallBottom.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(leftWallBottom);
        
        // Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ Î≤Ω Ï°∞Í∞ÅÎì§ (Ï§ëÍ∞Ñ ÎÜíÏù¥ 3)
        // Ï∞ΩÎ¨∏ ÏúÑÏπò: z = -15, -5, 5, 15 (Í∞Å ÌÅ¨Í∏∞ 6x3, Ï¶â z¬±3 Î≤îÏúÑ)
        // Ï∞ΩÎ¨∏1: z=-18~-12, Ï∞ΩÎ¨∏2: z=-8~-2, Ï∞ΩÎ¨∏3: z=2~8, Ï∞ΩÎ¨∏4: z=12~18
        const leftWallSegments = [
            { z: -19, width: 2 },     // Î∂ÅÏ™Ω ÎÅù (z=-20~-18)
            { z: -10, width: 4 },     // 1-2Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=-12~-8)
            { z: 0, width: 4 },       // 2-3Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=-2~2)
            { z: 10, width: 4 },      // 3-4Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=8~12)
            { z: 19, width: 2 }       // ÎÇ®Ï™Ω ÎÅù (z=18~20)
        ];
        
        leftWallSegments.forEach(seg => {
            const wallPiece = new THREE.Mesh(
                new THREE.BoxGeometry(wallThickness, 3, seg.width),
                wallMaterial
            );
            wallPiece.position.set(-20, 2.5, seg.z);
            wallPiece.receiveShadow = true;
            wallPiece.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
            scene.add(wallPiece);
        });
        
        // Right wall with window holes (ÎèôÏ™Ω Î≤Ω)
        // ÏúÑÏ™Ω Î≤Ω
        const rightWallTop = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        rightWallTop.position.set(20, 4.5, 0);
        rightWallTop.receiveShadow = true;
        rightWallTop.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(rightWallTop);
        
        // ÏïÑÎûòÏ™Ω Î≤Ω (Î∞îÎã•Î∂ÄÌÑ∞ ÏãúÏûë)
        const rightWallBottom = new THREE.Mesh(
            new THREE.BoxGeometry(wallThickness, 1, 40),
            wallMaterial
        );
        rightWallBottom.position.set(20, 0.5, 0);
        rightWallBottom.receiveShadow = true;
        rightWallBottom.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
        scene.add(rightWallBottom);
        
        // Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ Î≤Ω Ï°∞Í∞ÅÎì§
        const rightWallSegments = [
            { z: -19, width: 2 },     // Î∂ÅÏ™Ω ÎÅù (z=-20~-18)
            { z: -10, width: 4 },     // 1-2Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=-12~-8)
            { z: 0, width: 4 },       // 2-3Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=-2~2)
            { z: 10, width: 4 },      // 3-4Î≤à Ï∞ΩÎ¨∏ ÏÇ¨Ïù¥ (z=8~12)
            { z: 19, width: 2 }       // ÎÇ®Ï™Ω ÎÅù (z=18~20)
        ];
        
        rightWallSegments.forEach(seg => {
            const wallPiece = new THREE.Mesh(
                new THREE.BoxGeometry(wallThickness, 3, seg.width),
                wallMaterial
            );
            wallPiece.position.set(20, 2.5, seg.z);
            wallPiece.receiveShadow = true;
            wallPiece.castShadow = false; // Í∑∏Î¶ºÏûê ÏÉùÏÑ± ÎπÑÌôúÏÑ±Ìôî
            scene.add(wallPiece);
        });
        
        // Office furniture
        const woodMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xb4e7ce, // ÌååÏä§ÌÖî ÎÖπÏÉâ
            roughness: 0.6,
            metalness: 0.1
        });
        
        const metalMaterial = new THREE.MeshStandardMaterial({
            color: 0x808080, // ÌöåÏÉâ
            roughness: 0.3,
            metalness: 0.8
        });
        
        const lightGreyMaterial = new THREE.MeshStandardMaterial({
            color: 0xffffff, // Ìù∞ÏÉâ (Í∞ÄÏû• Î∞ùÍ≤å)
            roughness: 0.3,
            metalness: 0.5
        });
        
        // Create detailed desks
        function createDesk(x, z) {
            const deskGroup = new THREE.Group();
            
            // Desk top
            const deskTop = new THREE.Mesh(
                new THREE.BoxGeometry(3, 0.1, 1.5),
                woodMaterial
            );
            deskTop.position.y = 0.75;
            deskTop.castShadow = true;
            deskTop.receiveShadow = true;
            deskGroup.add(deskTop);
            
            // Metal frame
            const frameGeometry = new THREE.BoxGeometry(0.05, 0.7, 0.05);
            const framePositions = [
                [-1.45, 0.35, -0.7],
                [1.45, 0.35, -0.7],
                [-1.45, 0.35, 0.7],
                [1.45, 0.35, 0.7]
            ];
            
            framePositions.forEach(pos => {
                const frame = new THREE.Mesh(frameGeometry, metalMaterial);
                frame.position.set(...pos);
                frame.castShadow = true;
                deskGroup.add(frame);
            });
            
            // Computer monitor base
            const monitorBase = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 0.05, 16),
                lightGreyMaterial
            );
            monitorBase.position.set(0, 0.82, 0);
            monitorBase.castShadow = true;
            monitorBase.receiveShadow = true;
            deskGroup.add(monitorBase);
            
            const monitorStand = new THREE.Mesh(
                new THREE.BoxGeometry(0.05, 0.3, 0.05),
                lightGreyMaterial
            );
            monitorStand.position.set(0, 0.97, 0);
            monitorStand.castShadow = true;
            monitorStand.receiveShadow = true;
            deskGroup.add(monitorStand);
            
            // Monitor body (Î∞ùÏùÄ ÌöåÏÉâ)
            const monitorBody = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 0.7, 0.05),
                lightGreyMaterial
            );
            monitorBody.position.set(0, 1.3, 0);
            monitorBody.castShadow = true;
            monitorBody.receiveShadow = true;
            deskGroup.add(monitorBody);
            
            // Monitor screen (Í≤ÄÏ†ïÏÉâ Ïï°Ï†ï)
            const monitorScreen = new THREE.Mesh(
                new THREE.BoxGeometry(1.1, 0.6, 0.02),
                new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.1, metalness: 0.5 })
            );
            monitorScreen.position.set(0, 1.3, 0.035);
            monitorScreen.castShadow = true;
            monitorScreen.receiveShadow = true;
            deskGroup.add(monitorScreen);
            
            // Ïù¥Î™®ÏßÄ ÌëúÏãúÏö© Î©îÏãú Ï†ÄÏû•
            deskGroup.userData.monitorScreen = monitorScreen;
            deskGroup.userData.emojiMesh = null; // ÎÇòÏ§ëÏóê Ïù¥Î™®ÏßÄ Î©îÏãú Ï†ÄÏû•
            
            // Keyboard (Í∞ÄÎ°ú 2Î∞∞, ÏúÑÏπò Ï°∞Ï†ï)
            const keyboard = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 0.02, 0.15),
                lightGreyMaterial
            );
            keyboard.position.set(0, 0.81, 0.5);
            keyboard.castShadow = true;
            keyboard.receiveShadow = true;
            deskGroup.add(keyboard);
            
            deskGroup.position.set(x, 0, z);
            return deskGroup;
        }
        
        // Ï±ÖÏÉÅ Î™®ÎãàÌÑ∞Ïóê Ïù¥Î™®ÏßÄ ÌëúÏãú Ìï®Ïàò
        function showEmojiOnDesk(deskX, deskZ, emoji) {
            // Ìï¥Îãπ ÏúÑÏπòÏùò Ï±ÖÏÉÅ Ï∞æÍ∏∞
            const desk = desks.find(d => 
                Math.abs(d.position.x - deskX) < 0.1 && 
                Math.abs(d.position.z - deskZ) < 0.1
            );
            
            if (!desk) return;
            
            // Í∏∞Ï°¥ Ïù¥Î™®ÏßÄ Ï†úÍ±∞
            if (desk.userData.emojiMesh) {
                desk.remove(desk.userData.emojiMesh);
            }
            
            // Ï∫îÎ≤ÑÏä§Ïóê Ïù¥Î™®ÏßÄ Í∑∏Î¶¨Í∏∞
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.font = 'bold 180px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, canvas.width / 2, canvas.height / 2);
            
            // ÌÖçÏä§Ï≤ò ÏÉùÏÑ±
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture,
                transparent: true
            });
            
            // Î™®ÎãàÌÑ∞ ÌôîÎ©¥ ÌÅ¨Í∏∞Ïóê ÎßûÍ≤å Î©îÏãú ÏÉùÏÑ±
            const emojiMesh = new THREE.Mesh(
                new THREE.PlaneGeometry(1.1, 0.6),
                material
            );
            emojiMesh.position.set(0, 1.3, 0.055); // Î™®ÎãàÌÑ∞ Ïä§ÌÅ¨Î¶∞ Ïïû
            desk.add(emojiMesh);
            desk.userData.emojiMesh = emojiMesh;
        }
        
        // Add desks
        const desk1 = createDesk(-10, -10);
        const desk2 = createDesk(0, -10);
        const desk3 = createDesk(10, -10);
        const desk4 = createDesk(-10, 0);
        const desk5 = createDesk(0, 0);
        const desk6 = createDesk(10, 0);
        const desk7 = createDesk(-10, 10);
        const desk8 = createDesk(0, 10);
        const desk9 = createDesk(10, 10);
        scene.add(desk1, desk2, desk3, desk4, desk5, desk6, desk7, desk8, desk9);
        
        // Ï±ÖÏÉÅ Î∞∞Ïó¥ (Ï∂©Îèå Í∞êÏßÄÏö©)
        const desks = [desk1, desk2, desk3, desk4, desk5, desk6, desk7, desk8, desk9];
        
        // Add whiteboards with funny drawings
        const blackboardMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x1a1a1a, // Í≤ÄÏ†ïÏÉâ (ÏïΩÍ∞Ñ Î∞ùÍ≤å)
            roughness: 0.8,
            metalness: 0.1
        });
        
        const blackboard = new THREE.Mesh(
            new THREE.BoxGeometry(9, 3, 0.1),
            blackboardMaterial
        );
        blackboard.position.set(0, 2.5, -19.8);
        blackboard.castShadow = true;
        scene.add(blackboard);
        
        // Ïπ†Ìåê ÌÖçÏä§Ìä∏ Î©îÏãú (ÎÇòÏ§ëÏóê ÏóÖÎç∞Ïù¥Ìä∏)
        let blackboardWithText = null;
        
        // Ïπ†Ìåê ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateBlackboard(info) {
            // Í∏∞Ï°¥ Ïπ†Ìåê ÌÖçÏä§Ìä∏ Ï†úÍ±∞
            if (blackboardWithText) {
                scene.remove(blackboardWithText);
            }
            
            // Ïπ†ÌåêÏóê ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
            const blackboardCanvas = document.createElement('canvas');
            blackboardCanvas.width = 2048;
            blackboardCanvas.height = 1024;
            const blackboardCtx = blackboardCanvas.getContext('2d');
            
            // Î∞∞Í≤Ω (Ïπ†Ìåê ÏÉâÏÉÅ)
            blackboardCtx.fillStyle = '#1a1a1a';
            blackboardCtx.fillRect(0, 0, blackboardCanvas.width, blackboardCanvas.height);
            
            // ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
            blackboardCtx.textAlign = 'center';
            blackboardCtx.textBaseline = 'middle';
            
            // 1Ï§Ñ: Îã®ÏõêÎ™Ö (Ìù∞ÏÉâ, ÌÅ∞ Ìè∞Ìä∏)
            blackboardCtx.fillStyle = '#ffffff';
            blackboardCtx.font = 'bold 100px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line1, blackboardCanvas.width / 2, 180);
            
            // 2Ï§Ñ: ÌïôÏäµÏ£ºÏ†ú (ÎÖ∏ÎûÄÏÉâ, ÌÅ∞ Ìè∞Ìä∏)
            blackboardCtx.fillStyle = '#ffeb3b';
            blackboardCtx.font = 'bold 80px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line2, blackboardCanvas.width / 2, 320);
            
            // 3-4-5Ï§Ñ: ÌôúÎèô (Ìù∞ÏÉâ, ÏûëÏùÄ Ìè∞Ìä∏)
            blackboardCtx.fillStyle = '#ffffff';
            blackboardCtx.font = '60px "Noto Sans KR", sans-serif';
            blackboardCtx.fillText(info.line3, blackboardCanvas.width / 2, 520);
            blackboardCtx.fillText(info.line4, blackboardCanvas.width / 2, 650);
            blackboardCtx.fillText(info.line5, blackboardCanvas.width / 2, 780);
            
            // ÌÖçÏä§Ï≤ò ÏÉùÏÑ± Î∞è Ï†ÅÏö©
            const blackboardTexture = new THREE.CanvasTexture(blackboardCanvas);
            const blackboardTextMaterial = new THREE.MeshStandardMaterial({ 
                map: blackboardTexture,
                roughness: 0.8,
                metalness: 0.1
            });
            
            blackboardWithText = new THREE.Mesh(
                new THREE.BoxGeometry(9, 3, 0.1),
                blackboardTextMaterial
            );
            blackboardWithText.position.set(0, 2.5, -19.79); // Ïπ†ÌåêÎ≥¥Îã§ ÏïΩÍ∞Ñ ÏïûÏúºÎ°ú
            scene.add(blackboardWithText);
        }
        
        // Ï¥àÍ∏∞ Ïπ†Ìåê (Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï†Ñ)
        updateBlackboard({
            line1: 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...',
            line2: '',
            line3: '',
            line4: '',
            line5: ''
        });
        
        // Character creation with more detail
        const characters = [];
        
        function createCharacter(name, role, x, z, shirtColor, characterData) {
            const group = new THREE.Group();
            
            // Torso
            const torsoGeometry = new THREE.CylinderGeometry(0.23, 0.3, 0.6, 8);
            const torsoMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const torso = new THREE.Mesh(torsoGeometry, torsoMaterial);
            torso.position.y = 0.7;
            torso.castShadow = true;
            group.add(torso);
            
            // Arms (Ïñ¥Íπ®ÏóêÏÑú ÌöåÏ†ÑÌïòÎèÑÎ°ù ÏÑ§Ï†ï)
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.6, 6);
            const armMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            
            // ÌåîÏùÑ Ïª®ÌÖåÏù¥ÎÑàÏóê ÎÑ£Ïñ¥ÏÑú ÌöåÏ†Ñ Ï§ëÏã¨ÏùÑ Ïñ¥Íπ®Î°ú ÏÑ§Ï†ï
            const leftArmContainer = new THREE.Group();
            leftArmContainer.position.set(-0.28, 1.0, 0); // Î™∏ÌÜµ Ï™ΩÏúºÎ°ú Ïù¥Îèô (-0.33 ‚Üí -0.28)
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.y = -0.3; // ÌåîÏùÑ ÏïÑÎûòÎ°ú Ïò§ÌîÑÏÖã (ÌöåÏ†Ñ Ï§ëÏã¨Ïù¥ ÏúÑÏóê ÏûàÎèÑÎ°ù)
            leftArm.castShadow = true;
            leftArmContainer.add(leftArm);
            leftArmContainer.rotation.z = -Math.PI / 12; // 15ÎèÑ Î≤åÏñ¥Ïßê (180/12 = 15)
            group.add(leftArmContainer);
            
            const rightArmContainer = new THREE.Group();
            rightArmContainer.position.set(0.28, 1.0, 0); // Î™∏ÌÜµ Ï™ΩÏúºÎ°ú Ïù¥Îèô (0.33 ‚Üí 0.28)
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.y = -0.3; // ÌåîÏùÑ ÏïÑÎûòÎ°ú Ïò§ÌîÑÏÖã (ÌöåÏ†Ñ Ï§ëÏã¨Ïù¥ ÏúÑÏóê ÏûàÎèÑÎ°ù)
            rightArm.castShadow = true;
            rightArmContainer.add(rightArm);
            rightArmContainer.rotation.z = Math.PI / 12; // 15ÎèÑ Î≤åÏñ¥Ïßê (180/12 = 15)
            group.add(rightArmContainer);
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.6, 6);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, 0.3, 0);
            group.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, 0.3, 0);
            group.add(rightLeg);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25, 8, 6);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffe4c4 }); // Îçî Î∞ùÏùÄ ÌîºÎ∂ÄÏÉâ (Bisque)
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.25;
            head.castShadow = true;
            group.add(head);
            
            // Hair
            const hairGeometry = new THREE.SphereGeometry(0.27, 8, 6);
            const hairMaterial = new THREE.MeshStandardMaterial({ color: shirtColor });
            const hair = new THREE.Mesh(hairGeometry, hairMaterial);
            hair.position.y = 1.38; // 0.03 ÏúÑÎ°ú Ïù¥Îèô (1.35 ‚Üí 1.38)
            hair.scale.y = 0.6;
            group.add(hair);
            
            // Eyes
            const eyeGeometry = new THREE.SphereGeometry(0.03, 4, 4);
            const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.08, 1.25, 0.22);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.08, 1.25, 0.22);
            group.add(rightEye);
            
            // Name label
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Ïù¥Î¶Ñ Í∏∏Ïù¥ Ï∏°Ï†ï
            context.font = 'bold 24px "Noto Sans KR", sans-serif';
            const nameWidth = context.measureText(name).width;
            const padding = 20; // Ï¢åÏö∞ Ïó¨Î∞±
            const canvasWidth = Math.max(nameWidth + padding * 2, 100); // ÏµúÏÜå Ìè≠ 100
            const canvasHeight = 50;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Î∞∞Í≤Ω (Ìù∞ÏÉâ Î∞òÌà¨Î™Ö)
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // Ïù¥Î¶Ñ ÌÖçÏä§Ìä∏ (Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨)
            context.fillStyle = 'black';
            context.font = 'bold 24px "Noto Sans KR", sans-serif';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(name, canvasWidth / 2, canvasHeight / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ map: texture });
            const label = new THREE.Sprite(labelMaterial);
            
            // Î®∏Î¶¨Ïπ¥ÎùΩ Ï†úÏùº ÏúóÎ∂ÄÎ∂ÑÏóêÏÑú 0.1 ÏúÑ + 0.2 Ï∂îÍ∞Ä ÏÉÅÏäπ
            // Î®∏Î¶¨Ïπ¥ÎùΩ Ï§ëÏã¨: y = 1.38, Î∞òÏßÄÎ¶Ñ: 0.27, y scale: 0.6
            // Ï†úÏùº ÏúóÎ∂ÄÎ∂Ñ: 1.38 + (0.27 * 0.6) = 1.542
            label.position.y = 1.542 + 0.1 + 0.2; // 1.842
            
            // ÎùºÎ≤® ÌÅ¨Í∏∞Î•º Ïù¥Î¶Ñ Í∏∏Ïù¥Ïóê ÎπÑÎ°ÄÌïòÏó¨ Ï°∞Ï†à
            const labelWidth = canvasWidth / 128; // Í∏∞Î≥∏ ÎπÑÏú® Ï°∞Ï†ï
            const labelHeight = canvasHeight / 128;
            label.scale.set(labelWidth, labelHeight, 1);
            
            group.add(label);
            
            group.position.set(x, 0, z);
            
            // Î∂ÅÏ™Ω(z=-20 Î∞©Ìñ•)ÏùÑ Î∞îÎùºÎ≥¥ÎèÑÎ°ù 180ÎèÑ ÌöåÏ†Ñ
            group.rotation.y = Math.PI;
            
            group.userData = { 
                name, 
                role, 
                conversations: [],
                initialPosition: new THREE.Vector3(x, 0, z),
                initialized: false, // ÏµúÏ¥à Î∞©Ìñ• ÏÑ§Ï†ï Ïó¨Î∂Ä
                stopUntil: null, // Ï†ïÏßÄ ÏãúÍ∞Ñ (ÌîåÎ†àÏù¥Ïñ¥ Ï∂©Îèå Ïãú)
                speed: 2.5, // Ïù¥Îèô ÏÜçÎèÑ
                isDancing: false,
                hasCoffee: Math.random() > 0.5,
                stuckInDoor: false,
                tripChance: 0.001,
                leftArm: leftArmContainer, // Ïª®ÌÖåÏù¥ÎÑà Ï∞∏Ï°∞
                rightArm: rightArmContainer, // Ïª®ÌÖåÏù¥ÎÑà Ï∞∏Ï°∞
                ...characterData
            };
            
            characters.push(group);
            return group;
        }
        
        // ÌïôÏÉù ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (Ï§ëÍ∞Ñ Ï±ÑÎèÑÏùò Î∂ÄÎìúÎü¨Ïö¥ ÌÜ§ 9ÏÉâ)
        const studentColors = [
            0xe8e8e8, // Î∞ùÏùÄ ÌöåÏÉâ (Î∂ÄÎìúÎü¨Ïö¥ Ìù∞ÏÉâ)
            0xff6b6b, // ÏΩîÎûÑ Î†àÎìú (Ï†ÅÎãπÌïú Îπ®Í∞ï)
            0x4dabf7, // Î∞ùÏùÄ Î∏îÎ£® (Ï†ÅÎãπÌïú ÌååÎûë)
            0xffd43b, // ÏÑ†ÏÉ§Ïù∏ ÏòêÎ°úÏö∞ (Ï†ÅÎãπÌïú ÎÖ∏Îûë)
            0x51cf66, // ÎØºÌä∏ Í∑∏Î¶∞ (Ï†ÅÎãπÌïú Ï¥àÎ°ù)
            0xff922b, // ÌÉ†Ï†ÄÎ¶∞ (Ï†ÅÎãπÌïú Ïò§Î†åÏßÄ)
            0x9775fa, // Î∞îÏù¥Ïò¨Î†õ (Ï†ÅÎãπÌïú Î≥¥Îùº)
            0xff6b9d, // Î°úÏ¶à ÌïëÌÅ¨ (Ï†ÅÎãπÌïú ÌïëÌÅ¨)
            0x3bc9db  // ÏãúÏïà Î∏îÎ£® (Ï†ÅÎãπÌïú ÌïòÎäòÏÉâ)
        ];
        
        // Î∞∞Ïó¥ ÏÑûÍ∏∞ Ìï®Ïàò (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // ÌïôÏÉù ÏÉâÏÉÅ ÎûúÎç§ ÏÑûÍ∏∞
        const shuffledColors = shuffleArray(studentColors);
        
        // Add characters with varied appearances and quirks
        // ÏÑ†ÏÉùÎãò: ÌôîÏù¥Ìä∏Î≥¥Îìú(0, 0, -19.8)ÏóêÏÑú ÎÇ®Ï™Ω(Z+)ÏúºÎ°ú 5
        // ÏïÑÏ£º ÏßÑÌïú ÌöåÏÉâ
        const teacher = createCharacter('ÏÑ†ÏÉùÎãò', '', 0, -14.8, 0x404040, {
            hairColor: 0x404040
        });
        teacher.userData.originalPosition = { x: 0, z: -14.8 };
        teacher.userData.completed = false;
        teacher.userData.deskPosition = null; // ÏÑ†ÏÉùÎãòÏùÄ Ï±ÖÏÉÅÏù¥ ÏóÜÏùå
        
        // ÌïôÏÉùÎì§: Í∞Å Ï±ÖÏÉÅÏóêÏÑú ÎÇ®Ï™Ω(Z+)ÏúºÎ°ú 2
        // ÎûúÎç§ ÏÉâÏÉÅ Ï†ÅÏö© (9Î™ÖÏóêÍ≤å 9Í∞ÄÏßÄ ÏÉâÏÉÅÏùÑ Ï§ëÎ≥µ ÏóÜÏù¥ Î∞∞Ï†ï)
        // Ï±ÖÏÉÅ1: (-10, -10) ‚Üí ÌïôÏÉù1: (-10, -8)
        const student1 = createCharacter('ÌïôÏÉù1', '', -10, -8, shuffledColors[0], {
            hairColor: shuffledColors[0]
        });
        student1.userData.originalPosition = { x: -10, z: -8 };
        student1.userData.completed = false;
        student1.userData.deskPosition = { x: -10, z: -10 };
        
        // Ï±ÖÏÉÅ2: (0, -10) ‚Üí ÌïôÏÉù2: (0, -8)
        const student2 = createCharacter('ÌïôÏÉù2', '', 0, -8, shuffledColors[1], {
            hairColor: shuffledColors[1]
        });
        student2.userData.originalPosition = { x: 0, z: -8 };
        student2.userData.completed = false;
        student2.userData.deskPosition = { x: 0, z: -10 };
        
        // Ï±ÖÏÉÅ3: (10, -10) ‚Üí ÌïôÏÉù3: (10, -8)
        const student3 = createCharacter('ÌïôÏÉù3', '', 10, -8, shuffledColors[2], {
            hairColor: shuffledColors[2]
        });
        student3.userData.originalPosition = { x: 10, z: -8 };
        student3.userData.completed = false;
        student3.userData.deskPosition = { x: 10, z: -10 };
        
        // Ï±ÖÏÉÅ4: (-10, 0) ‚Üí ÌïôÏÉù4: (-10, 2)
        const student4 = createCharacter('ÌïôÏÉù4', '', -10, 2, shuffledColors[3], {
            hairColor: shuffledColors[3]
        });
        student4.userData.originalPosition = { x: -10, z: 2 };
        student4.userData.completed = false;
        student4.userData.deskPosition = { x: -10, z: 0 };
        
        // Ï±ÖÏÉÅ5: (0, 0) ‚Üí ÌïôÏÉù5: (0, 2)
        const student5 = createCharacter('ÌïôÏÉù5', '', 0, 2, shuffledColors[4], {
            hairColor: shuffledColors[4]
        });
        student5.userData.originalPosition = { x: 0, z: 2 };
        student5.userData.completed = false;
        student5.userData.deskPosition = { x: 0, z: 0 };
        
        // Ï±ÖÏÉÅ6: (10, 0) ‚Üí ÌïôÏÉù6: (10, 2)
        const student6 = createCharacter('ÌïôÏÉù6', '', 10, 2, shuffledColors[5], {
            hairColor: shuffledColors[5]
        });
        student6.userData.originalPosition = { x: 10, z: 2 };
        student6.userData.completed = false;
        student6.userData.deskPosition = { x: 10, z: 0 };
        
        // Ï±ÖÏÉÅ7: (-10, 10) ‚Üí ÌïôÏÉù7: (-10, 12)
        const student7 = createCharacter('ÌïôÏÉù7', '', -10, 12, shuffledColors[6], {
            hairColor: shuffledColors[6]
        });
        student7.userData.originalPosition = { x: -10, z: 12 };
        student7.userData.completed = false;
        student7.userData.deskPosition = { x: -10, z: 10 };
        
        // Ï±ÖÏÉÅ8: (0, 10) ‚Üí ÌïôÏÉù8: (0, 12)
        const student8 = createCharacter('ÌïôÏÉù8', '', 0, 12, shuffledColors[7], {
            hairColor: shuffledColors[7]
        });
        student8.userData.originalPosition = { x: 0, z: 12 };
        student8.userData.completed = false;
        student8.userData.deskPosition = { x: 0, z: 10 };
        
        // Ï±ÖÏÉÅ9: (10, 10) ‚Üí ÌïôÏÉù9: (10, 12)
        const student9 = createCharacter('ÌïôÏÉù9', '', 10, 12, shuffledColors[8], {
            hairColor: shuffledColors[8]
        });
        student9.userData.originalPosition = { x: 10, z: 12 };
        student9.userData.completed = false;
        student9.userData.deskPosition = { x: 10, z: 10 };
        
        scene.add(teacher, student1, student2, student3, student4, student5, student6, student7, student8, student9);
        
        // ÏÑ†ÏÉùÎãò ÌÅ¨Í∏∞Î•º 130%Î°ú ÏÑ§Ï†ï
        teacher.scale.set(1.3, 1.3, 1.3);
        
        // ÌïôÏÉùÎì§ ÌÅ¨Í∏∞Î•º 110%Î°ú ÏÑ§Ï†ï
        [student1, student2, student3, student4, student5, student6, student7, student8, student9].forEach(character => {
            character.scale.set(1.1, 1.1, 1.1);
        });
        
        // Player controls
        // ÎÇ®Ï™Ω Î≤Ω Ï§ëÏïô(0, 0, 20)ÏóêÏÑú Î∂ÅÏ™ΩÏúºÎ°ú 5 Ïù¥Îèô ‚Üí (0, 1.6, 15)
        const player = {
            position: new THREE.Vector3(0, 1.25, 15),
            velocity: new THREE.Vector3(0, 0, 0),
            speed: 0.05, // ÏÜçÎèÑ 50% Í∞êÏÜå
            isDancing: false
        };
        
        // Ï∫êÎ¶≠ÌÑ∞ ÏõÄÏßÅÏûÑ ÌôúÏÑ±Ìôî ÌîåÎûòÍ∑∏
        let charactersCanMove = false;
        
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            keys[e.key] = true; // Store original key for arrow keys
            
            // Prevent arrow keys from scrolling the page
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
            keys[e.key] = false; // Clear original key for arrow keys
        });
        
        // UI Î≤ÑÌäº Í∏∞Îä• ÏÑ§Ï†ï
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº
        const navButtons = {
            up: document.getElementById('nav-up'),
            down: document.getElementById('nav-down'),
            left: document.getElementById('nav-left'),
            right: document.getElementById('nav-right')
        };
        
        // Î≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÌÇ§ ÏÉÅÌÉú Î≥ÄÍ≤Ω
        Object.keys(navButtons).forEach(direction => {
            const button = navButtons[direction];
            const arrowKey = 'Arrow' + direction.charAt(0).toUpperCase() + direction.slice(1);
            
            // ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
            button.addEventListener('mousedown', () => {
                keys[arrowKey] = true;
            });
            button.addEventListener('mouseup', () => {
                keys[arrowKey] = false;
            });
            button.addEventListener('mouseleave', () => {
                keys[arrowKey] = false;
            });
            
            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
            button.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys[arrowKey] = true;
            });
            button.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys[arrowKey] = false;
            });
        });
        
        // Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î≤ÑÌäº
        document.getElementById('screenshot-button').addEventListener('click', () => {
            try {
                // UI ÏöîÏÜåÎì§ Ïà®Í∏∞Í∏∞
                const uiElements = [
                    document.getElementById('screenshot-button'),
                    document.getElementById('fullscreen-button'),
                    document.getElementById('navigation-controls'),
                    document.getElementById('progress-bar')
                ];
                
                uiElements.forEach(el => {
                    if (el) el.classList.add('hide-ui');
                });
                
                // Ïû†Ïãú ÎåÄÍ∏∞ ÌõÑ Ï∫°Ï≤ò (UIÍ∞Ä ÏôÑÏ†ÑÌûà Ïà®Í≤®ÏßÄÎèÑÎ°ù)
                setTimeout(() => {
                    const canvas = renderer.domElement;
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'ÍµêÏã§_ÏãúÎÆ¨Î†àÏù¥ÌÑ∞_' + new Date().getTime() + '.jpg';
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        // UI ÏöîÏÜåÎì§ Îã§Ïãú ÌëúÏãú
                        uiElements.forEach(el => {
                            if (el) el.classList.remove('hide-ui');
                        });
                    }, 'image/jpeg', 0.95);
                }, 50);
            } catch (error) {
                console.error('Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï†ÄÏû• Ïã§Ìå®:', error);
                // Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ UI Î≥µÍµ¨
                const uiElements = [
                    document.getElementById('screenshot-button'),
                    document.getElementById('fullscreen-button'),
                    document.getElementById('navigation-controls'),
                    document.getElementById('progress-bar')
                ];
                uiElements.forEach(el => {
                    if (el) el.classList.remove('hide-ui');
                });
            }
        });
        
        // Ï†ÑÏ≤¥ÌôîÎ©¥ Î≤ÑÌäº
        document.getElementById('fullscreen-button').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Ï†ÑÏ≤¥ÌôîÎ©¥ Ï†ÑÌôò Ïã§Ìå®:', err);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        // ÏßÑÌñâ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateProgressBar() {
            const completedCount = characters.filter(c => c.userData.completed).length;
            const progressBar = document.getElementById('progress-bar');
            
            // Ïà´ÏûêÎ•º Í∑∏ÎåÄÎ°ú ÌëúÏãú (1, 2, ... 10)
            progressBar.textContent = completedCount.toString();
        }
        
        // Character movement AI with chaos
        // ÌóàÏö©Îêú ÌöåÏ†Ñ Í∞ÅÎèÑ (ÎùºÎîîÏïà)
        const allowedAngles = [-120, -90, -60, -30, 30, 60, 90, 120].map(deg => deg * Math.PI / 180);
        
        // ÎûúÎç§ Í∞ÅÎèÑ ÏÑ†ÌÉù Ìï®Ïàò
        function getRandomAngle() {
            return allowedAngles[Math.floor(Math.random() * allowedAngles.length)];
        }
        
        function updateCharacterMovement(character, deltaTime) {
            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏõÄÏßÅÏù¥Í∏∞ Ï†ÑÍπåÏßÄ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÏßÄ
            if (!charactersCanMove) {
                return;
            }
            
            // ÏôÑÎ£åÎêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏßëÏúºÎ°ú ÎèåÏïÑÍ∞ÄÎäî Ï§ë
            if (character.userData.returningHome) {
                const targetPos = character.userData.targetPosition;
                const dx = targetPos.x - character.position.x;
                const dz = targetPos.z - character.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                
                // Î™©Ìëú ÏßÄÏ†êÏóê ÎèÑÏ∞©ÌñàÎäîÏßÄ ÌôïÏù∏ (0.1 Í±∞Î¶¨ Ïù¥ÎÇ¥)
                if (distance < 0.1) {
                    // Ï†ïÌôïÌïú ÏúÑÏπòÎ°ú ÏÑ§Ï†ï
                    character.position.x = targetPos.x;
                    character.position.z = targetPos.z;
                    
                    // Î∞©Ìñ• ÏÑ§Ï†ï: ÏÑ†ÏÉùÎãòÏùÄ ÎÇ®Ï™Ω(0), ÌïôÏÉùÏùÄ Î∂ÅÏ™Ω(Math.PI)
                    if (character.userData.name === 'ÏÑ†ÏÉùÎãò') {
                        character.rotation.y = 0; // ÎÇ®Ï™Ω
                    } else {
                        character.rotation.y = Math.PI; // Î∂ÅÏ™Ω
                    }
                    
                    // ÌåîÏùÑ ÏõêÎûò ÏúÑÏπòÎ°ú
                    character.userData.leftArm.rotation.x = 0;
                    character.userData.rightArm.rotation.x = 0;
                    
                    // Ïßë ÎèÑÏ∞© ÏôÑÎ£å
                    character.userData.returningHome = false;
                    character.userData.initialized = false; // Îã§Ïãú ÏõÄÏßÅÏù¥ÏßÄ ÏïäÎèÑÎ°ù
                    return;
                }
                
                // Î™©Ìëú ÏßÄÏ†êÏùÑ Ìñ•Ìï¥ Ïù¥Îèô
                const moveSpeed = 1.25; // ÏÜçÎèÑ 50% Í∞êÏÜå
                const direction = new THREE.Vector3(dx, 0, dz).normalize();
                character.position.add(direction.multiplyScalar(moveSpeed * deltaTime));
                
                // Î™©Ìëú ÏßÄÏ†êÏùÑ Î∞îÎùºÎ≥¥ÎèÑÎ°ù ÌöåÏ†Ñ
                const angle = Math.atan2(dx, dz);
                character.rotation.y = angle;
                
                // Í±∑Îäî Ïï†ÎãàÎ©îÏù¥ÏÖò (Ìåî ÌùîÎì§Í∏∞)
                const walkSpeed = 8;
                character.userData.leftArm.rotation.x = Math.sin(Date.now() * 0.005 * walkSpeed) * 0.5;
                character.userData.rightArm.rotation.x = -Math.sin(Date.now() * 0.005 * walkSpeed) * 0.5;
                
                return;
            }
            
            // ÏôÑÎ£åÎêú Ï∫êÎ¶≠ÌÑ∞Îäî ÏõÄÏßÅÏù¥ÏßÄ ÏïäÏùå (Ï†úÏûêÎ¶¨Ïóê Ï†ïÏßÄ)
            if (character.userData.completed) {
                character.userData.leftArm.rotation.x = 0;
                character.userData.rightArm.rotation.x = 0;
                return;
            }
            
            // Don't move if this character is in conversation
            if (character === currentCharacter) {
                // Face the player
                const lookTarget = new THREE.Vector3(player.position.x, character.position.y, player.position.z);
                character.lookAt(lookTarget);
                character.rotation.x = 0;
                character.rotation.z = 0;
                return;
            }
            
            // Ï†ïÏßÄ Ï§ëÏù∏ Ï∫êÎ¶≠ÌÑ∞ Ï≤òÎ¶¨
            if (character.userData.stopUntil && Date.now() < character.userData.stopUntil) {
                // Ï†ïÏßÄ Ï§ëÏóêÎèÑ ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ• ÌôïÏù∏ (Í∑ºÏ≤òÏóê ÏûàÏúºÎ©¥ Î∞îÎùºÎ≥¥Í∏∞)
                const dx = player.position.x - character.position.x;
                const dz = player.position.z - character.position.z;
                const distanceToPlayer = Math.sqrt(dx * dx + dz * dz);
                
                if (distanceToPlayer < 2) {
                    const lookTarget = new THREE.Vector3(player.position.x, character.position.y, player.position.z);
                    character.lookAt(lookTarget);
                    character.rotation.x = 0;
                    character.rotation.z = 0;
                }
                
                // Ï†ïÏßÄ Ïãú ÌåîÏùÑ ÏõêÎûò ÏúÑÏπòÎ°ú
                character.userData.leftArm.rotation.x = 0;
                character.userData.rightArm.rotation.x = 0;
                return; // Ï†ïÏßÄ ÏãúÍ∞ÑÏù¥ ÎÅùÎÇ† ÎïåÍπåÏßÄ ÏõÄÏßÅÏù¥ÏßÄ ÏïäÏùå
            } else if (character.userData.stopUntil) {
                // Ï†ïÏßÄ ÏãúÍ∞ÑÏù¥ ÎÅùÎÇ¨ÏúºÎ©¥ ÏÉàÎ°úÏö¥ Í∞ÅÎèÑÎ°ú ÌöåÏ†Ñ
                const rotationAngle = getRandomAngle();
                character.rotation.y += rotationAngle;
                character.userData.stopUntil = null;
            }
            
            // ÏµúÏ¥à Ïù¥Îèô Ïãú ÎûúÎç§ Í∞ÅÎèÑÎ°ú Î∞©Ìñ• ÏÑ§Ï†ï
            if (!character.userData.initialized) {
                character.rotation.y = Math.random() * Math.PI * 2; // Ï¥àÍ∏∞ Î∞©Ìñ• ÎûúÎç§
                character.userData.initialized = true;
            }
            
            // Ïù¥Îèô ÏÜçÎèÑ
            const moveSpeed = 1.25; // deltaTimeÍ≥º Ìï®Íªò ÏÇ¨Ïö© (50% Í∞êÏÜå)
            
            // ÌòÑÏû¨ Î∞îÎùºÎ≥¥Îäî Î∞©Ìñ•ÏúºÎ°ú ÏßÅÏßÑ
            const forwardDirection = new THREE.Vector3(
                Math.sin(character.rotation.y),
                0,
                Math.cos(character.rotation.y)
            );
            
            // ÏÉàÎ°úÏö¥ ÏúÑÏπò Í≥ÑÏÇ∞
            const newPosition = character.position.clone();
            newPosition.add(forwardDirection.multiplyScalar(moveSpeed * deltaTime));
            
            // Ï∂©Îèå Í∞êÏßÄ Î≥ÄÏàò
            let collisionDetected = false;
            let playerCollision = false;
            
            // 1. Ï±ÖÏÉÅÍ≥ºÏùò Ï∂©Îèå Í∞êÏßÄ
            const deskCollisionDistance = 2.0;
            for (let desk of desks) {
                const dx = newPosition.x - desk.position.x;
                const dz = newPosition.z - desk.position.z;
                const distSq = dx * dx + dz * dz;
                
                if (distSq < deskCollisionDistance * deskCollisionDistance) {
                    collisionDetected = true;
                    break;
                }
            }
            
            // 2. Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞ÏôÄÏùò Ï∂©Îèå Í∞êÏßÄ
            if (!collisionDetected) {
                const characterCollisionDistance = 1.5;
                for (let otherChar of characters) {
                    if (otherChar === character) continue;
                    
                    const dx = newPosition.x - otherChar.position.x;
                    const dz = newPosition.z - otherChar.position.z;
                    const distSq = dx * dx + dz * dz;
                    
                    if (distSq < characterCollisionDistance * characterCollisionDistance) {
                        collisionDetected = true;
                        break;
                    }
                }
            }
            
            // 3. ÌîåÎ†àÏù¥Ïñ¥ÏôÄÏùò Ï∂©Îèå Í∞êÏßÄ
            if (!collisionDetected) {
                const playerCollisionDistance = 1.5;
                const dx = newPosition.x - player.position.x;
                const dz = newPosition.z - player.position.z;
                const distSq = dx * dx + dz * dz;
                
                if (distSq < playerCollisionDistance * playerCollisionDistance) {
                    playerCollision = true;
                    collisionDetected = true;
                }
            }
            
            // 4. Í≤ΩÍ≥ÑÏôÄÏùò Ï∂©Îèå Í∞êÏßÄ
            if (Math.abs(newPosition.x) > 17 || Math.abs(newPosition.z) > 17) {
                collisionDetected = true;
            }
            
            // Ï∂©Îèå Ï≤òÎ¶¨
            if (collisionDetected) {
                // Î™®Îì† Ï∂©Îèå Ïãú Ï¶âÏãú ÎûúÎç§ Í∞ÅÎèÑÎ°ú ÌöåÏ†Ñ (ÌîåÎ†àÏù¥Ïñ¥ Ï∂©ÎèåÎèÑ ÎèôÏùº)
                const rotationAngle = getRandomAngle();
                character.rotation.y += rotationAngle;
            } else {
                // Ï∂©ÎèåÏù¥ ÏóÜÏúºÎ©¥ Ïù¥Îèô
                character.position.copy(newPosition);
                
                // Walking animation
                const walkBounce = Math.sin(Date.now() * 0.01) * 0.05;
                character.position.y = walkBounce;
                
                // Arm swinging animation
                const armSwing = Math.sin(Date.now() * 0.01) * 0.3;
                character.userData.leftArm.rotation.x = armSwing;
                character.userData.rightArm.rotation.x = -armSwing;
            }
            
            // Í≤ΩÍ≥Ñ ÎÇ¥Î°ú Ïú†ÏßÄ
            character.position.x = Math.max(-17, Math.min(17, character.position.x));
            character.position.z = Math.max(-17, Math.min(17, character.position.z));
            
            // ÌöåÏ†Ñ Í≥†Ï†ï (X, ZÏ∂ï)
            character.rotation.x = 0;
            character.rotation.z = 0;
        }
        
        // Dialogue system
        let currentCharacter = null;
        let nearbyCharacter = null;
        const dialogueBox = document.getElementById('dialogue-box');
        const dialogueName = document.getElementById('dialogue-name');
        const dialogueContent = document.getElementById('dialogue-content');
        const interactionPrompt = document.getElementById('interaction-prompt');
        
        // ÎåÄÌôî Î≤ÑÌäº ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
        interactionPrompt.addEventListener('click', () => {
            if (nearbyCharacter && !currentCharacter) {
                openDialogue(nearbyCharacter);
            }
        });
        
        interactionPrompt.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏Í∞Ä ÌÅ¥Î¶≠ÏúºÎ°ú Ï†ÑÌôòÎêòÎäî Í≤É Î∞©ÏßÄ
            if (nearbyCharacter && !currentCharacter) {
                openDialogue(nearbyCharacter);
            }
        });
        
        // ÎåÄÌôîÏ∞Ω Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        const dialogueCloseBtn = document.getElementById('dialogue-close-btn');
        
        dialogueCloseBtn.addEventListener('click', () => {
            dialogueBox.style.display = 'none';
            currentCharacter = null;
        });
        
        dialogueCloseBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            dialogueBox.style.display = 'none';
            currentCharacter = null;
        });
        
        function getQuizForCharacter(character) {
            const characterName = character.userData.name;
            const quizzes = characterQuizMap[characterName];
            
            if (!quizzes || quizzes.length === 0) {
                return {
                    character: characterName,
                    question: 'ÏïÑÏßÅ Ï§ÄÎπÑÎêú ÏßàÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.',
                    answer: ''
                };
            }
            
            // ÎûúÎç§ÌïòÍ≤å ÌÄ¥Ï¶à ÏÑ†ÌÉù
            const randomIndex = Math.floor(Math.random() * quizzes.length);
            return quizzes[randomIndex];
        }
        
        
        let currentQuiz = null;
        
        function openDialogue(character) {
            currentCharacter = character;
            
            // ÏÑ†ÏÉùÎãòÏùº Í≤ΩÏö∞ ÌïôÏÉù 9Î™Ö ÏôÑÎ£å Ïó¨Î∂Ä Ï≤¥ÌÅ¨
            if (character.userData.name === 'ÏÑ†ÏÉùÎãò') {
                const allStudentsCompleted = characters
                    .filter(c => c.userData.name !== 'ÏÑ†ÏÉùÎãò')
                    .every(c => c.userData.completed);
                
                if (!allStudentsCompleted) {
                    // ÌïôÏÉù Î¨∏Ï†úÎ•º Îã§ ÌíÄÏßÄ ÏïäÏïòÏúºÎ©¥ ÏûÖÎ†• ÌïÑÎìú ÌëúÏãú (Ïù¥Ïä§ÌÑ∞ ÏóêÍ∑∏Ïö©)
                    dialogueBox.style.display = 'block';
                    dialogueName.textContent = character.userData.name;
                    dialogueContent.textContent = 'ÍµêÏã§Ïóê ÏûàÎäî 9Î™ÖÏùò ÌïôÏÉùÎì§ Î¨∏Ï†úÎ•º Î™®Îëê ÌíÄÍ≥† Îã§Ïãú Ïò§ÏÑ∏Ïöî.';
                    
                    // ÏûÖÎ†• ÌïÑÎìú ÌëúÏãú (Ïù¥Ïä§ÌÑ∞ ÏóêÍ∑∏Ïö©)
                    document.getElementById('quiz-container').style.display = 'block';
                    const answerInput = document.getElementById('answer-input');
                    const submitButton = document.getElementById('submit-answer');
                    const feedback = document.getElementById('feedback');
                    answerInput.value = '';
                    answerInput.disabled = false;
                    submitButton.disabled = false; // Î≤ÑÌäº ÌôúÏÑ±Ìôî
                    answerInput.placeholder = 'ÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
                    feedback.style.display = 'none';
                    
                    // ÏûÑÏãú ÌÄ¥Ï¶à ÏÑ§Ï†ï (Ïù¥Ïä§ÌÑ∞ ÏóêÍ∑∏Ïö©)
                    currentQuiz = {
                        characterName: 'ÏÑ†ÏÉùÎãò',
                        question: '',
                        answer: ''
                    };
                    
                    // ÏÑ†ÏÉùÎãòÏù¥ Îí§ÎèåÏïÑÏÑúÍ∏∞ (180ÎèÑ ÌöåÏ†Ñ)
                    character.userData.stopUntil = Date.now() + 5000;
                    character.rotation.y = Math.PI;
                    
                    setTimeout(() => {
                        answerInput.focus();
                    }, 100);
                    
                    return;
                }
            }
            
            dialogueBox.style.display = 'block';
            
            // Ï∫êÎ¶≠ÌÑ∞Ïóê ÎßûÎäî ÌÄ¥Ï¶à Í∞ÄÏ†∏Ïò§Í∏∞
            currentQuiz = getQuizForCharacter(character);
            
            // Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ ÌëúÏãú (Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïùò Ïù¥Î¶Ñ)
            dialogueName.textContent = currentQuiz.characterName || character.userData.name;
            
            // ÏßàÎ¨∏ ÌëúÏãú
            dialogueContent.textContent = currentQuiz.question;
            
            // ÏûÖÎ†• ÌïÑÎìú ÌëúÏãú Î∞è Ï¥àÍ∏∞Ìôî
            document.getElementById('quiz-container').style.display = 'block';
            const answerInput = document.getElementById('answer-input');
            const submitButton = document.getElementById('submit-answer');
            const feedback = document.getElementById('feedback');
            answerInput.value = '';
            answerInput.disabled = false;
            submitButton.disabled = false; // Î≤ÑÌäº ÌôúÏÑ±Ìôî
            answerInput.placeholder = 'Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
            feedback.style.display = 'none';
            
            // ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
            setTimeout(() => {
                answerInput.focus();
            }, 100);
        }
        
        
        
        // ÏÉâÏ¢ÖÏù¥ ÏÉùÏÑ± Ìï®Ïàò
        function createConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff69b4'];
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    
                    // ÌÅ¨Í∏∞ Îã§ÏñëÌôî (5px ~ 20px)
                    const size = 5 + Math.random() * 15;
                    confetti.style.width = size + 'px';
                    confetti.style.height = size + 'px';
                    
                    // ÏúÑÏπò
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-20px';
                    
                    // ÏÉâÏÉÅ
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    
                    // Ìà¨Î™ÖÎèÑ (0.6 ~ 1.0) - 3D ÎäêÎÇå
                    confetti.style.opacity = 0.6 + Math.random() * 0.4;
                    
                    // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÍ∞Ñ (2 ~ 4Ï¥à)
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                    
                    // z-indexÎ°ú ÏõêÍ∑ºÍ∞ê (9990 ~ 9999)
                    confetti.style.zIndex = Math.floor(9990 + Math.random() * 10);
                    
                    // Ï¥àÍ∏∞ ÌöåÏ†Ñ Í∞ÅÎèÑ
                    confetti.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 30);
            }
        }
        
        // Î™®Îì† Î¨∏Ï†ú Ìï¥Í≤∞ Ïãú Ï∂ïÌïò Ïï†ÎãàÎ©îÏù¥ÏÖò
        let confettiInterval = null;
        
        function celebrateCompletion() {
            // Ï∂ïÌïò ÏùåÏïÖ Ïû¨ÏÉù
            playCelebrationMusic();
            
            // ÏÉâÏ¢ÖÏù¥ Ìö®Í≥º - Í≥ÑÏÜç Îñ®Ïñ¥ÏßÄÎèÑÎ°ù
            createConfetti();
            confettiInterval = setInterval(() => {
                createConfetti();
            }, 3000); // 3Ï¥àÎßàÎã§ ÏÉâÏ¢ÖÏù¥ Îã§Ïãú ÏÉùÏÑ±
            
            // Ï∂ïÌïò Î©îÏãúÏßÄ ÌëúÏãú
            const celebrationMessage = document.getElementById('celebration-message');
            celebrationMessage.style.display = 'block';
            
            // Î™®Îì† Ï∫êÎ¶≠ÌÑ∞Í∞Ä Ï†êÌîÑ (ÎßåÏÑ∏ ÎèôÏûë ÏóÜÏù¥)
            characters.forEach(character => {
                let jumpCount = 0;
                const jumpInterval = setInterval(() => {
                    if (jumpCount >= 10) {
                        clearInterval(jumpInterval);
                        character.position.y = 0;
                        return;
                    }
                    
                    // Ï†êÌîÑ Ïï†ÎãàÎ©îÏù¥ÏÖò
                    const jumpHeight = 0.5;
                    const jumpDuration = 300;
                    const startY = character.position.y;
                    const startTime = Date.now();
                    
                    const animateJump = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = elapsed / jumpDuration;
                        
                        if (progress < 0.5) {
                            character.position.y = startY + jumpHeight * (progress * 2);
                        } else if (progress < 1) {
                            character.position.y = startY + jumpHeight * (2 - progress * 2);
                        } else {
                            character.position.y = startY;
                            jumpCount++;
                            return;
                        }
                        
                        requestAnimationFrame(animateJump);
                    };
                    
                    animateJump();
                }, 400);
            });
            
            // 5Ï¥à ÌõÑ Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞ (ÏÉâÏ¢ÖÏù¥Îäî Í≥ÑÏÜç Îñ®Ïñ¥Ïßê)
            setTimeout(() => {
                celebrationMessage.style.display = 'none';
            }, 5000);
        }
        
        function checkAnswer() {
            if (!currentQuiz || !currentCharacter) return;
            
            const answerInput = document.getElementById('answer-input');
            const feedback = document.getElementById('feedback');
            const submitButton = document.getElementById('submit-answer');
            
            const userAnswer = answerInput.value.trim();
            
            // Ïù¥Ïä§ÌÑ∞ ÏóêÍ∑∏ Ï≤¥ÌÅ¨ (ÏÑ†ÏÉùÎãòÍ≥º ÎåÄÌôî Ï§ëÏùº Îïå)
            if (currentCharacter.userData.name === 'ÏÑ†ÏÉùÎãò' && 
                (userAnswer === 'Ï°∞ÌòÑÏßÄ' || userAnswer === 'whguswl')) {
                
                // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî
                initAudioContext();
                
                // Î™®Îì† ÌïôÏÉùÏùÑ ÏôÑÎ£å ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
                characters.forEach(character => {
                    if (character.userData.name !== 'ÏÑ†ÏÉùÎãò') {
                        character.userData.completed = true;
                        character.userData.returningHome = true;
                        character.userData.targetPosition = character.userData.originalPosition;
                        
                        // Ïù¥Î¶Ñ ÎùºÎ≤® Ï†úÍ±∞
                        const labelToRemove = character.children.find(child => child.isSprite);
                        if (labelToRemove) {
                            character.remove(labelToRemove);
                        }
                        
                        // Ï±ÖÏÉÅÏóê Ïù¥Î™®ÏßÄ ÌëúÏãú
                        if (character.userData.deskPosition) {
                            showEmojiOnDesk(
                                character.userData.deskPosition.x,
                                character.userData.deskPosition.z,
                                'üéâ'
                            );
                        }
                    }
                });
                
                // ÏÑ†ÏÉùÎãòÎèÑ ÏôÑÎ£å ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ïÌïòÍ≥† ÏõêÎûò ÏúÑÏπòÎ°ú Ïù¥Îèô
                currentCharacter.userData.completed = true;
                currentCharacter.userData.returningHome = true;
                currentCharacter.userData.targetPosition = currentCharacter.userData.originalPosition;
                
                // ÏßÑÌñâ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateProgressBar();
                
                // ÏÑ†ÏÉùÎãò Ïù¥Î¶Ñ ÎùºÎ≤® Ï†úÍ±∞
                const teacherLabel = currentCharacter.children.find(child => child.isSprite);
                if (teacherLabel) {
                    currentCharacter.remove(teacherLabel);
                }
                
                // ÏõêÎûò ÏúÑÏπòÎ•º Î∞îÎùºÎ≥¥ÎèÑÎ°ù ÌöåÏ†Ñ
                const originalPos = currentCharacter.userData.originalPosition;
                const dx = originalPos.x - currentCharacter.position.x;
                const dz = originalPos.z - currentCharacter.position.z;
                const angle = Math.atan2(dx, dz);
                currentCharacter.rotation.y = angle;
                
                feedback.style.display = 'block';
                feedback.style.background = '#ffd700';
                feedback.style.color = '#333';
                feedback.textContent = 'üåü Ïù¥Ïä§ÌÑ∞ ÏóêÍ∑∏ Î∞úÍ≤¨! Î™®Îì† Î¨∏Ï†úÍ∞Ä Ìï¥Í≤∞ÎêòÏóàÏäµÎãàÎã§!';
                
                playCorrectSound();
                
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                    currentCharacter = null;
                    
                    // Ïû†Ïãú ÌõÑ Ï∂ïÌïò Ïï†ÎãàÎ©îÏù¥ÏÖò
                    setTimeout(() => {
                        celebrateCompletion();
                    }, 2000);
                }, 2000);
                
                return;
            }
            
            const correctAnswer = currentQuiz.answer.trim();
            
            if (userAnswer === '') {
                feedback.style.display = 'block';
                feedback.style.background = '#fff3cd';
                feedback.style.color = '#856404';
                feedback.textContent = 'ÎãµÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!';
                return;
            }
            
            // Ï†ïÎãµ ÎπÑÍµê (ÎåÄÏÜåÎ¨∏Ïûê Î¨¥Ïãú, Í≥µÎ∞± Ï†úÍ±∞)
            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            
            answerInput.disabled = true;
            submitButton.disabled = true;
            
            if (isCorrect) {
                // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî Î∞è Ï†ïÎãµ Ìö®Í≥ºÏùå
                initAudioContext();
                playCorrectSound();
                
                feedback.style.display = 'block';
                feedback.style.background = '#d4edda';
                feedback.style.color = '#155724';
                feedback.textContent = 'üéâ Ï†ïÎãµÏûÖÎãàÎã§!';
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏôÑÎ£å ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                currentCharacter.userData.completed = true;
                currentCharacter.userData.returningHome = true; // ÏßëÏúºÎ°ú ÎèåÏïÑÍ∞ÄÎäî Ï§ë
                currentCharacter.userData.targetPosition = currentCharacter.userData.originalPosition;
                
                // ÏßÑÌñâ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                updateProgressBar();
                
                // ÏõêÎûò ÏúÑÏπòÎ•º Î∞îÎùºÎ≥¥ÎèÑÎ°ù ÌöåÏ†Ñ
                const originalPos = currentCharacter.userData.originalPosition;
                const dx = originalPos.x - currentCharacter.position.x;
                const dz = originalPos.z - currentCharacter.position.z;
                const angle = Math.atan2(dx, dz);
                currentCharacter.rotation.y = angle;
                
                // Ïù¥Î¶Ñ ÎùºÎ≤® Ï†úÍ±∞ (childrenÏóêÏÑú Sprite Ï∞æÏïÑÏÑú Ï†úÍ±∞)
                const labelToRemove = currentCharacter.children.find(child => child.isSprite);
                if (labelToRemove) {
                    currentCharacter.remove(labelToRemove);
                }
                
                // Ï±ÖÏÉÅ Î™®ÎãàÌÑ∞Ïóê Ïù¥Î™®ÏßÄ ÌëúÏãú (ÌïôÏÉùÎßå)
                if (currentCharacter.userData.deskPosition) {
                    showEmojiOnDesk(
                        currentCharacter.userData.deskPosition.x,
                        currentCharacter.userData.deskPosition.z,
                        'üéâ'
                    );
                }
                
                // ÏÑ†ÏÉùÎãò Î¨∏Ï†úÎ•º ÌíÄÏóàÎäîÏßÄ ÌôïÏù∏
                const isTeacher = currentCharacter.userData.name === 'ÏÑ†ÏÉùÎãò';
                
                // 2Ï¥à ÌõÑ ÎåÄÌôîÏ∞Ω Îã´Í∏∞
                setTimeout(() => {
                    dialogueBox.style.display = 'none';
                    currentCharacter = null;
                    
                    // ÏÑ†ÏÉùÎãò Î¨∏Ï†úÎ•º ÌíÄÏóàÏùÑ ÎïåÎßå Ï∂ïÌïò Ïï†ÎãàÎ©îÏù¥ÏÖò
                    if (isTeacher) {
                        setTimeout(() => {
                            celebrateCompletion();
                        }, 2000);
                    }
                }, 2000);
            } else {
                // Ïò§Îãµ Ìö®Í≥ºÏùå
                initAudioContext();
                playWrongSound();
                
                feedback.style.display = 'block';
                feedback.style.background = '#f8d7da';
                feedback.style.color = '#721c24';
                feedback.textContent = '‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§!';
                
                // 2Ï¥à ÌõÑ ÏÉà Î¨∏Ï†ú (Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî)
                setTimeout(() => {
                    submitButton.disabled = false;
                    openDialogue(currentCharacter);
                }, 2000);
            }
        }
        
        // Set up custom question handlers
        // DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎêú ÌõÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        let answerInputElement = null;
        let submitButtonElement = null;
        
        function setupEventListeners() {
            answerInputElement = document.getElementById('answer-input');
            submitButtonElement = document.getElementById('submit-answer');
            
            if (submitButtonElement && answerInputElement) {
                // Ï§ëÎ≥µ Î∞©ÏßÄÎ•º ÏúÑÌï¥ Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ ÌõÑ Ïû¨Îì±Î°ù
                submitButtonElement.removeEventListener('click', checkAnswer);
                submitButtonElement.addEventListener('click', checkAnswer);
                
                answerInputElement.removeEventListener('keypress', handleEnterKey);
                answerInputElement.addEventListener('keypress', handleEnterKey);
            }
        }
        
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkAnswer();
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ìïú Î≤à Ïã§Ìñâ
        setupEventListeners();
        
        // Animation loop
        let lastTime = 0;
        
        function animate(currentTime) {
            requestAnimationFrame(animate);
            
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            // Update player movement
            player.velocity.set(0, 0, 0);
            
            // ÎåÄÌôî Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå Ïù¥Îèô Í∞ÄÎä•
            if (!currentCharacter) {
                // Î∞©Ìñ•ÌÇ§Î°ú Ïù¥Îèô
                if (keys['ArrowUp']) player.velocity.z = player.speed;
                if (keys['ArrowDown']) player.velocity.z = -player.speed;
                if (keys['ArrowLeft']) player.velocity.x = -player.speed;
                if (keys['ArrowRight']) player.velocity.x = player.speed;
            }
            
            // Update camera rotation based on mouse (Ï¢åÏö∞Îßå)
            camera.rotation.y = mouseX;
            camera.rotation.x = 0; // ÏÉÅÌïò ÌöåÏ†Ñ Í≥†Ï†ï
            
            // Apply movement in camera direction
            const forward = new THREE.Vector3(0, 0, -1);
            forward.applyQuaternion(camera.quaternion);
            forward.y = 0;
            forward.normalize();
            
            const right = new THREE.Vector3(1, 0, 0);
            right.applyQuaternion(camera.quaternion);
            right.y = 0;
            right.normalize();
            
            // ÏÉàÎ°úÏö¥ ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò Í≥ÑÏÇ∞
            const newPlayerPosition = player.position.clone();
            newPlayerPosition.add(forward.multiplyScalar(player.velocity.z));
            newPlayerPosition.add(right.multiplyScalar(player.velocity.x));
            
            // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏõÄÏßÅÏòÄÎäîÏßÄ ÌôïÏù∏ (velocityÍ∞Ä 0Ïù¥ ÏïÑÎãàÎ©¥)
            if (!charactersCanMove && (player.velocity.x !== 0 || player.velocity.z !== 0)) {
                charactersCanMove = true;
            }
            
            // Ï∂©Îèå Í∞êÏßÄ
            let playerCollision = false;
            
            // 1. Ï±ÖÏÉÅÍ≥ºÏùò Ï∂©Îèå Í∞êÏßÄ
            const deskCollisionDistance = 1.8;
            for (let desk of desks) {
                const dx = newPlayerPosition.x - desk.position.x;
                const dz = newPlayerPosition.z - desk.position.z;
                const distSq = dx * dx + dz * dz; // Ï†úÍ≥±Í∑º ÏÉùÎûµ (ÏµúÏ†ÅÌôî)
                
                if (distSq < deskCollisionDistance * deskCollisionDistance) {
                    playerCollision = true;
                    break;
                }
            }
            
            // 2. Ï∫êÎ¶≠ÌÑ∞ÏôÄÏùò Ï∂©Îèå Í∞êÏßÄ
            if (!playerCollision) {
                const characterCollisionDistance = 1.5;
                for (let character of characters) {
                    const dx = newPlayerPosition.x - character.position.x;
                    const dz = newPlayerPosition.z - character.position.z;
                    const distSq = dx * dx + dz * dz;
                    
                    if (distSq < characterCollisionDistance * characterCollisionDistance) {
                        playerCollision = true;
                        break;
                    }
                }
            }
            
            // Ï∂©ÎèåÏù¥ ÏóÜÏúºÎ©¥ Ïù¥Îèô
            if (!playerCollision) {
                player.position.copy(newPlayerPosition);
            }
            
            // Keep player in bounds
            player.position.x = Math.max(-18, Math.min(18, player.position.x));
            player.position.z = Math.max(-18, Math.min(18, player.position.z));
            
            // Update camera position
            camera.position.copy(player.position);
            camera.rotation.z = 0;
            camera.rotation.y = mouseX;
            camera.rotation.x = 0; // ÏÉÅÌïò ÌöåÏ†Ñ Í≥†Ï†ï
            
            // Update character movement (ÎåÄÌôî Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå)
            if (!currentCharacter) {
                characters.forEach(character => {
                    updateCharacterMovement(character, deltaTime);
                });
            }
            
            // Check for nearby characters (ÏàòÌèâ Í±∞Î¶¨Îßå Í≥ÑÏÇ∞)
            nearbyCharacter = null;
            let minDistance = Infinity;
            
            characters.forEach(character => {
                // yÏ∂ïÏùÑ Î¨¥ÏãúÌïòÍ≥† x, z ÌèâÎ©¥ÏóêÏÑúÏùò Í±∞Î¶¨Îßå Í≥ÑÏÇ∞
                const dx = player.position.x - character.position.x;
                const dz = player.position.z - character.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                
                if (distance < 2 && distance < minDistance) {
                    minDistance = distance;
                    nearbyCharacter = character;
                }
            });
            
            // Auto-close dialogue if player walks away (ÎåÄÌôî Ï§ëÏóêÎäî ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏõÄÏßÅÏù¥ÏßÄ ÏïäÏúºÎØÄÎ°ú Î∂àÌïÑÏöî)
            // ÎåÄÌôîÏ∞ΩÏùÄ X Î≤ÑÌäºÏúºÎ°úÎßå Îã´Ìûò
            
            // Show/hide interaction prompt
            if (nearbyCharacter && !currentCharacter && !nearbyCharacter.userData.completed) {
                interactionPrompt.style.display = 'flex';
                interactionPrompt.textContent = 'ÎåÄÌôîÌïòÍ∏∞';
                
                // Ïù¥ÎØ∏ Ï†ïÏßÄ Ï§ëÏù∏ Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
                const alreadyStoppedCharacter = characters.find(char => 
                    char.userData.stopUntil && Date.now() < char.userData.stopUntil
                );
                
                // Ïù¥ÎØ∏ Ï†ïÏßÄ Ï§ëÏù∏ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò, Í∑ºÏ≤ò Ï∫êÎ¶≠ÌÑ∞Í∞Ä Î∞îÎ°ú Í∑∏ Ï∫êÎ¶≠ÌÑ∞Ïù∏ Í≤ΩÏö∞ÏóêÎßå ÏÑ§Ï†ï
                if (!alreadyStoppedCharacter || alreadyStoppedCharacter === nearbyCharacter) {
                    // stopUntilÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Ïù¥ÎØ∏ ÎßåÎ£åÎêú Í≤ΩÏö∞ÏóêÎßå ÏÉàÎ°ú ÏÑ§Ï†ï
                    if (!nearbyCharacter.userData.stopUntil || Date.now() >= nearbyCharacter.userData.stopUntil) {
                        // Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌîåÎ†àÏù¥Ïñ¥Î•º Î∞îÎùºÎ≥¥Í≤å ÏÑ§Ï†ï
                        const lookTarget = new THREE.Vector3(player.position.x, nearbyCharacter.position.y, player.position.z);
                        nearbyCharacter.lookAt(lookTarget);
                        nearbyCharacter.rotation.x = 0;
                        nearbyCharacter.rotation.z = 0;
                        
                        // 2Ï¥àÍ∞Ñ Ï†ïÏßÄ ÏÑ§Ï†ï
                        nearbyCharacter.userData.stopUntil = Date.now() + 2000;
                    }
                }
            } else {
                interactionPrompt.style.display = 'none';
            }
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Mouse look
        let mouseX = 0;
        let mouseY = 0;
        
        // Mouse drag for camera rotation
        let isDragging = false;
        let previousMouseX = 0;
        
        renderer.domElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMouseX = e.clientX;
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - previousMouseX;
                mouseX -= deltaX * 0.005; // ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏Î°ú ÏãúÏ†ê ÌöåÏ†Ñ
                previousMouseX = e.clientX;
            }
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // Touch swipe for camera rotation (Ïä§ÎßàÌä∏Ìå®Îìú/Î™®Î∞îÏùº)
        let touchStartX = 0;
        let isTouching = false;
        
        renderer.domElement.addEventListener('touchstart', (e) => {
            // Ìïú ÏÜêÍ∞ÄÎùΩÎßå ÌóàÏö©
            if (e.touches.length === 1) {
                isTouching = true;
                touchStartX = e.touches[0].clientX;
                e.preventDefault();
            } else {
                // Îëê ÏÜêÍ∞ÄÎùΩ Ïù¥ÏÉÅÏù¥Î©¥ ÌÑ∞Ïπò Î¨¥Ïãú
                isTouching = false;
            }
        });
        
        renderer.domElement.addEventListener('touchmove', (e) => {
            // Ìïú ÏÜêÍ∞ÄÎùΩÎßå ÌóàÏö©, ÌÑ∞Ïπò Ï§ëÏù¥Ïñ¥Ïïº Ìï®
            if (isTouching && e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - touchStartX;
                mouseX -= deltaX * 0.005; // ÌÑ∞Ïπò Ïä§ÏôÄÏù¥ÌîÑÎ°ú ÏãúÏ†ê ÌöåÏ†Ñ
                touchStartX = e.touches[0].clientX;
                e.preventDefault();
            } else if (e.touches.length > 1) {
                // Îëê ÏÜêÍ∞ÄÎùΩ Ïù¥ÏÉÅÏù¥Î©¥ ÌÑ∞Ïπò Ï§ëÎã®
                isTouching = false;
            }
        });
        
        renderer.domElement.addEventListener('touchend', (e) => {
            // Î™®Îì† ÌÑ∞ÏπòÍ∞Ä ÎÅùÎÇ¨ÏùÑ ÎïåÎßå Ï¥àÍ∏∞Ìôî
            if (e.touches.length === 0) {
                isTouching = false;
            }
        });
        
        renderer.domElement.addEventListener('touchcancel', () => {
            // ÌÑ∞ÏπòÍ∞Ä Ï∑®ÏÜåÎêòÎ©¥ Ï¶âÏãú Ï¥àÍ∏∞Ìôî
            isTouching = false;
        });
        
        
        // Ïï± ÏãúÏûë - Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        loadQuizData().then(success => {
            if (success) {
                updateProgressBar(); // Ï¥àÍ∏∞ ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú
                animate(0);
            } else {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®Î°ú Ïï±ÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        });
    </script>
</body>
</html>